<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Nextflow training</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!-- fixes nowrap line numbers https://github.com/asciidoctor/asciidoctor/issues/1706#issuecomment-314601209 -->
<style>
table.CodeRay { display: block; overflow-x: auto; }
td.code > pre { white-space: pre; }
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Nextflow training <span class="image right Seqera Labs Logo"><img src="img/seqera-logo-black.png" alt="Logo" width="300" height="100"></span></h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_environment_setup">1. Environment setup</a>
<ul class="sectlevel2">
<li><a href="#_requirements">1.1. Requirements</a></li>
<li><a href="#_nextflow_installation">1.2. Nextflow installation</a></li>
</ul>
</li>
<li><a href="#_get_started_with_nextflow">2. Get started with Nextflow</a>
<ul class="sectlevel2">
<li><a href="#_basic_concepts">2.1. Basic concepts</a>
<ul class="sectlevel3">
<li><a href="#_processes_and_channels">2.1.1. Processes and channels</a></li>
<li><a href="#_execution_abstraction">2.1.2. Execution abstraction</a></li>
<li><a href="#_scripting_language">2.1.3. Scripting language</a></li>
</ul>
</li>
<li><a href="#_your_first_script">2.2. Your first script</a></li>
<li><a href="#_modify_and_resume">2.3. Modify and resume</a></li>
<li><a href="#_pipeline_parameters">2.4. Pipeline parameters</a></li>
</ul>
</li>
<li><a href="#_channels">3. Channels</a>
<ul class="sectlevel2">
<li><a href="#_channel_types">3.1. Channel types</a>
<ul class="sectlevel3">
<li><a href="#_queue_channel">3.1.1. Queue channel</a></li>
<li><a href="#_value_channels">3.1.2. Value channels</a></li>
</ul>
</li>
<li><a href="#_channel_factories">3.2. Channel factories</a>
<ul class="sectlevel3">
<li><a href="#_value">3.2.1. value</a></li>
<li><a href="#_from">3.2.2. from</a></li>
<li><a href="#_of">3.2.3. of</a></li>
<li><a href="#_fromlist">3.2.4. fromList</a></li>
<li><a href="#_frompath">3.2.5. fromPath</a></li>
<li><a href="#_fromfilepairs">3.2.6. fromFilePairs</a></li>
<li><a href="#_fromsra">3.2.7. fromSRA</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_processes">4. Processes</a>
<ul class="sectlevel2">
<li><a href="#_script">4.1. Script</a>
<ul class="sectlevel3">
<li><a href="#_script_parameters">4.1.1. Script parameters</a></li>
<li><a href="#_conditional_script">4.1.2. Conditional script</a></li>
</ul>
</li>
<li><a href="#_inputs">4.2. Inputs</a>
<ul class="sectlevel3">
<li><a href="#_input_values">4.2.1. Input values</a></li>
<li><a href="#_input_files">4.2.2. Input files</a></li>
<li><a href="#_input_path">4.2.3. Input path</a></li>
<li><a href="#_combine_input_channels">4.2.4. Combine input channels</a></li>
<li><a href="#_input_repeaters">4.2.5. Input repeaters</a></li>
</ul>
</li>
<li><a href="#_outputs">4.3. Outputs</a>
<ul class="sectlevel3">
<li><a href="#_output_values">4.3.1. Output values</a></li>
<li><a href="#_output_files">4.3.2. Output files</a></li>
<li><a href="#_multiple_output_files">4.3.3. Multiple output files</a></li>
<li><a href="#_dynamic_output_file_names">4.3.4. Dynamic output file names</a></li>
<li><a href="#_composite_inputs_and_outputs">4.3.5. Composite inputs and outputs</a></li>
</ul>
</li>
<li><a href="#_when">4.4. When</a></li>
<li><a href="#_directives">4.5. Directives</a>
<ul class="sectlevel3">
<li><a href="#_exercise_10">4.5.1. Exercise</a></li>
</ul>
</li>
<li><a href="#_organise_outputs">4.6. Organise outputs</a>
<ul class="sectlevel3">
<li><a href="#_publishdir_directive">4.6.1. PublishDir directive</a></li>
<li><a href="#_manage_semantic_sub_directories">4.6.2. Manage semantic sub-directories</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_operators">5. Operators</a>
<ul class="sectlevel2">
<li><a href="#_basic_example">5.1. Basic example</a></li>
<li><a href="#_basic_operators">5.2. Basic operators</a>
<ul class="sectlevel3">
<li><a href="#_view">5.2.1. view</a></li>
<li><a href="#_map">5.2.2. map</a></li>
<li><a href="#_into">5.2.3. into</a></li>
<li><a href="#_mix">5.2.4. mix</a></li>
<li><a href="#_flatten">5.2.5. flatten</a></li>
<li><a href="#_collect">5.2.6. collect</a></li>
<li><a href="#_grouptuple">5.2.7. groupTuple</a></li>
<li><a href="#_join">5.2.8. join</a></li>
<li><a href="#_branch">5.2.9. branch</a></li>
</ul>
</li>
<li><a href="#_more_resources">5.3. More resources</a></li>
</ul>
</li>
<li><a href="#_groovy_basic_structures_and_idioms">6. Groovy basic structures and idioms</a>
<ul class="sectlevel2">
<li><a href="#_printing_values">6.1. Printing values</a></li>
<li><a href="#_comments">6.2. Comments</a></li>
<li><a href="#_variables">6.3. Variables</a></li>
<li><a href="#_lists">6.4. Lists</a></li>
<li><a href="#_maps">6.5. Maps</a></li>
<li><a href="#_string_interpolation">6.6. String interpolation</a></li>
<li><a href="#_multi_line_strings">6.7. Multi-line strings</a></li>
<li><a href="#_if_statement">6.8. If statement</a></li>
<li><a href="#_for_statement">6.9. For statement</a></li>
<li><a href="#_functions">6.10. Functions</a></li>
<li><a href="#_closures">6.11. Closures</a></li>
<li><a href="#_more_resources_2">6.12. More resources</a></li>
</ul>
</li>
<li><a href="#_simple_rna_seq_pipeline">7. Simple Rna-Seq pipeline</a>
<ul class="sectlevel2">
<li><a href="#_define_the_pipeline_parameters">7.1. Define the pipeline parameters</a>
<ul class="sectlevel3">
<li><a href="#_exercise_13">7.1.1. Exercise</a></li>
<li><a href="#_exercise_14">7.1.2. Exercise</a></li>
<li><a href="#_recap">7.1.3. Recap</a></li>
</ul>
</li>
<li><a href="#_create_transcriptome_index_file">7.2. Create transcriptome index file</a>
<ul class="sectlevel3">
<li><a href="#_exercise_15">7.2.1. Exercise</a></li>
<li><a href="#_exercise_16">7.2.2. Exercise</a></li>
<li><a href="#_exercise_17">7.2.3. Exercise</a></li>
<li><a href="#_recap_2">7.2.4. Recap</a></li>
</ul>
</li>
<li><a href="#_collect_read_files_by_pairs">7.3. Collect read files by pairs</a>
<ul class="sectlevel3">
<li><a href="#_exercise_18">7.3.1. Exercise</a></li>
<li><a href="#_exercise_19">7.3.2. Exercise</a></li>
<li><a href="#_recap_3">7.3.3. Recap</a></li>
</ul>
</li>
<li><a href="#_perform_expression_quantification">7.4. Perform expression quantification</a>
<ul class="sectlevel3">
<li><a href="#_exercise_20">7.4.1. Exercise</a></li>
<li><a href="#_exercise_21">7.4.2. Exercise</a></li>
<li><a href="#_recap_4">7.4.3. Recap</a></li>
</ul>
</li>
<li><a href="#_quality_control">7.5. Quality control</a>
<ul class="sectlevel3">
<li><a href="#_exercise_22">7.5.1. Exercise</a></li>
<li><a href="#_recap_5">7.5.2. Recap</a></li>
</ul>
</li>
<li><a href="#_multiqc_report">7.6. MultiQC report</a>
<ul class="sectlevel3">
<li><a href="#_recap_6">7.6.1. Recap</a></li>
</ul>
</li>
<li><a href="#_handle_completion_event">7.7. Handle completion event</a></li>
<li><a href="#_bonus">7.8. Bonus!</a></li>
<li><a href="#_custom_scripts">7.9. Custom scripts</a>
<ul class="sectlevel3">
<li><a href="#_recap_7">7.9.1. Recap</a></li>
</ul>
</li>
<li><a href="#_metrics_and_reports">7.10. Metrics and reports</a></li>
<li><a href="#_run_a_project_from_github">7.11. Run a project from GitHub</a></li>
<li><a href="#_more_resources_3">7.12. More resources</a></li>
</ul>
</li>
<li><a href="#_manage_dependencies_containers">8. Manage dependencies &amp; containers</a>
<ul class="sectlevel2">
<li><a href="#_docker_hands_on">8.1. Docker hands-on</a>
<ul class="sectlevel3">
<li><a href="#_run_a_container">8.1.1. Run a container</a></li>
<li><a href="#_pull_a_container">8.1.2. Pull a container</a></li>
<li><a href="#_run_a_container_in_interactive_mode">8.1.3. Run a container in interactive mode</a></li>
<li><a href="#_your_first_dockerfile">8.1.4. Your first Dockerfile</a></li>
<li><a href="#_build_the_image">8.1.5. Build the image</a></li>
<li><a href="#_add_a_software_package_to_the_image">8.1.6. Add a software package to the image</a></li>
<li><a href="#_run_salmon_in_the_container">8.1.7. Run Salmon in the container</a></li>
<li><a href="#_file_system_mounts">8.1.8. File system mounts</a></li>
<li><a href="#_upload_the_container_in_the_docker_hub_bonus">8.1.9. Upload the container in the Docker Hub (bonus)</a></li>
<li><a href="#_run_a_nextflow_script_using_a_docker_container">8.1.10. Run a Nextflow script using a Docker container</a></li>
</ul>
</li>
<li><a href="#_singularity">8.2. Singularity</a>
<ul class="sectlevel3">
<li><a href="#_create_a_singularity_images">8.2.1. Create a Singularity images</a></li>
<li><a href="#_running_a_container">8.2.2. Running a container</a></li>
<li><a href="#_import_a_docker_image">8.2.3. Import a Docker image</a></li>
<li><a href="#_run_a_nextflow_script_using_a_singularity_container">8.2.4. Run a Nextflow script using a Singularity container</a></li>
<li><a href="#_the_singularity_container_library">8.2.5. The Singularity Container Library</a></li>
</ul>
</li>
<li><a href="#_condabioconda_packages">8.3. Conda/Bioconda packages</a>
<ul class="sectlevel3">
<li><a href="#_bonus_exercise">8.3.1. Bonus Exercise</a></li>
</ul>
</li>
<li><a href="#_biocontainers">8.4. BioContainers</a></li>
<li><a href="#_more_resources_4">8.5. More resources</a></li>
</ul>
</li>
<li><a href="#_nextflow_configuration">9. Nextflow configuration</a>
<ul class="sectlevel2">
<li><a href="#_configuration_file">9.1. Configuration file</a>
<ul class="sectlevel3">
<li><a href="#_config_syntax">9.1.1. Config syntax</a></li>
<li><a href="#_config_variables">9.1.2. Config variables</a></li>
<li><a href="#_config_comments">9.1.3. Config comments</a></li>
<li><a href="#_config_scopes">9.1.4. Config scopes</a></li>
<li><a href="#_config_params">9.1.5. Config params</a></li>
<li><a href="#_config_env">9.1.6. Config env</a></li>
<li><a href="#_config_process">9.1.7. Config process</a></li>
<li><a href="#_config_docker_execution">9.1.8. Config Docker execution</a></li>
<li><a href="#_config_singularity_execution">9.1.9. Config Singularity execution</a></li>
<li><a href="#_config_conda_execution">9.1.10. Config Conda execution</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_deployments_scenarios">10. Deployments scenarios</a>
<ul class="sectlevel2">
<li><a href="#_cluster_deployment">10.1. Cluster deployment</a></li>
<li><a href="#_managing_cluster_resources">10.2. Managing cluster resources</a>
<ul class="sectlevel3">
<li><a href="#_workflow_wide_resources">10.2.1. Workflow wide resources</a></li>
<li><a href="#_configure_process_by_name">10.2.2. Configure process by name</a></li>
<li><a href="#_configure_process_by_labels">10.2.3. Configure process by labels</a></li>
<li><a href="#_configure_multiple_containers">10.2.4. Configure multiple containers</a></li>
</ul>
</li>
<li><a href="#_configuration_profiles">10.3. Configuration profiles</a></li>
<li><a href="#_cloud_deployment">10.4. Cloud deployment</a></li>
<li><a href="#_volume_mounts">10.5. Volume mounts</a></li>
<li><a href="#_custom_job_definition">10.6. Custom job definition</a></li>
<li><a href="#_custom_image">10.7. Custom image</a></li>
<li><a href="#_launch_template">10.8. Launch template</a></li>
<li><a href="#_hybrid_deployments">10.9. Hybrid deployments</a></li>
</ul>
</li>
<li><a href="#_execution_cache_and_resume">11. Execution cache and resume</a>
<ul class="sectlevel2">
<li><a href="#_how_resume_works">11.1. How resume works</a></li>
<li><a href="#_work_directory">11.2. Work directory</a></li>
<li><a href="#_how_organize_in_silico_experiments">11.3. How organize in silico experiments</a></li>
<li><a href="#_execution_provenance">11.4. Execution provenance</a></li>
<li><a href="#_resume_troubleshooting">11.5. Resume troubleshooting</a></li>
</ul>
</li>
<li><a href="#_errors_handling_troubleshooting">12. Errors handling &amp; troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#_execution_errors_debugging">12.1. Execution errors debugging</a></li>
<li><a href="#_ignore_errors">12.2. Ignore errors</a></li>
<li><a href="#_automatic_error_fail_over">12.3. Automatic error fail-over</a></li>
<li><a href="#_retry_with_backoff">12.4. Retry with backoff</a></li>
<li><a href="#_dynamic_resources_allocation">12.5. Dynamic resources allocation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_environment_setup">1. Environment setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_requirements">1.1. Requirements</h3>
<div class="paragraph">
<p>Nextflow can be used on any POSIX compatible system (Linux, OS X, etc).
It requires Bash and
<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java
8 (or later, up to 12)</a> to be installed.</p>
</div>
<div class="paragraph">
<p>Optional requirement for this workshop:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.docker.com/">Docker</a> engine 1.10.x (or later)</p>
</li>
<li>
<p><a href="https://github.com/sylabs/singularity">Singularity</a> 2.5.x (or later, optional)</p>
</li>
<li>
<p><a href="https://conda.io/">Conda</a> 4.5 (or later, optional)</p>
</li>
<li>
<p><a href="http://www.graphviz.org/">Graphviz</a> (optional)</p>
</li>
<li>
<p>AWS Batch computing environment properly configured (optional)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_nextflow_installation">1.2. Nextflow installation</h3>
<div class="paragraph">
<p>Install the latest version of Nextflow copy &amp; pasting the following
snippet in a terminal window:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>curl get.nextflow.io | bash
mv nextflow ~/bin</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the correct installation running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>nextflow info</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started_with_nextflow">2. Get started with Nextflow</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basic_concepts">2.1. Basic concepts</h3>
<div class="paragraph">
<p>Nextflow is workflow orchestration engine and a programming domain specific language (DSL)
that eases the writing of data-intensive computational pipelines.</p>
</div>
<div class="paragraph">
<p>It is designed around the idea that the Linux platform is the <em>lingua franca</em> of data science.
Linux provides many simple but powerful command-line and scripting tools that, when chained together,
facilitate complex data manipulations.</p>
</div>
<div class="paragraph">
<p>Nextflow extends this approach, adding the ability to define complex program interactions and a
high-level parallel computational environment based on the dataflow programming model. Nextflow
core features are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enable workflows portability &amp; reproducibility</p>
</li>
<li>
<p>simplify parallelization and large scale deployment</p>
</li>
<li>
<p>easily integrate existing tools, systems &amp; industry standards</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_processes_and_channels">2.1.1. Processes and channels</h4>
<div class="paragraph">
<p>In practice a Nextflow pipeline script is made by joining together different processes.
Each process can be written in any scripting language that can be executed by the Linux platform
(Bash, Perl, Ruby, Python, etc.).</p>
</div>
<div class="paragraph">
<p>Processes are executed independently and are isolated from each other, i.e. they do not share a common
(writable) state. The only way they can communicate is via asynchronous FIFO queues, called
<em>channels</em> in Nextflow.</p>
</div>
<div class="paragraph">
<p>Any process can define one or more channels as input and output. The interaction between these processes,
and ultimately the pipeline execution flow itself, is implicitly defined by these input and output declarations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/channel-process.png" alt="channel process">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_execution_abstraction">2.1.2. Execution abstraction</h4>
<div class="paragraph">
<p>While a process defines <em>what</em> command or script has to be executed, the executor determines
how that script is actually run in the target system.</p>
</div>
<div class="paragraph">
<p>If not otherwise specified, processes are executed on the local computer. The local executor
is very useful for pipeline development and testing purposes, but for real world computational
pipelines an HPC or cloud platform is often required.</p>
</div>
<div class="paragraph">
<p>In other words, Nextflow provides an abstraction between the pipeline&#8217;s functional logic and
the underlying execution system. Thus it is possible to write a pipeline once and to seamlessly
run it on your computer, a grid platform, or the cloud, without modifying it, by simply defining
the target execution platform in the configuration file.</p>
</div>
<div class="paragraph">
<p>It provides out-of-the-box support for major batch schedulers and cloud platforms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grid engine (Open/Sun/Univa)</p>
</li>
<li>
<p>IBM Platform LSF</p>
</li>
<li>
<p>Linux SLURM</p>
</li>
<li>
<p>PBS Works</p>
</li>
<li>
<p>Torque</p>
</li>
<li>
<p>Moab</p>
</li>
<li>
<p>HTCondor</p>
</li>
<li>
<p>Amazon Batch</p>
</li>
<li>
<p>Google Life Sciences</p>
</li>
<li>
<p>Kubernetes</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_scripting_language">2.1.3. Scripting language</h4>
<div class="paragraph">
<p>Nextflow implements declarative domain specific language (DSL) simplifies the writing of
writing complex data analysis workflows as an extension of a general purpose programming language.</p>
</div>
<div class="paragraph">
<p>This approach makes Nextflow very flexible because allows to have in the same
computing environment the benefit of concise DSL that allow the handling of
recurrent use cases with ease <strong>and</strong> the flexibility and power of a general purpose
programming language to handle corner cases, which may be difficult to implement using
a declarative approach.</p>
</div>
<div class="paragraph">
<p>In practical terms Nextflow scripting is an extension of the <a href="https://groovy-lang.org/">Groovy programming language</a>,
which in turn is a super-set of the Java programming language. Groovy can be considered as Python for Java in that
is simplifies the writing of code and is more approachable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_your_first_script">2.2. Your first script</h3>
<div class="paragraph">
<p>Copy the following example into your favourite text editor and save it
to a file named <code>hello.nf</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
  <td class="code"><pre>#!/usr/bin/env nextflow

params.greeting  = 'Hello world!'
greeting_ch = Channel.from(params.greeting)

process splitLetters {

    input:
    val x from greeting_ch

    output:
    file 'chunk_*' into letters

    &quot;&quot;&quot;
    printf '$x' | split -b 6 - chunk_
    &quot;&quot;&quot;
}

process convertToUpper {

    input:
    file y from letters.flatten()

    output:
    stdout into result

    &quot;&quot;&quot;
    cat $y | tr '[a-z]' '[A-Z]'
    &quot;&quot;&quot;
}

result.view{ it.trim() }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This script defines two processes. The first splits a string into files
containing chunks of 6 characters. The second receives these files and
transforms their contents to uppercase letters. The resulting strings
are emitted on the <code>result</code> channel and the final output is printed by
the <code>view</code> operator.</p>
</div>
<div class="paragraph">
<p>Execute the script by entering the following command in your terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run hello.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will output something similar to the text shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">N E X T F L O W  ~  version 20.01.0
Launching `hello.nf` [marvelous_plateau] - revision: 63f8ad7155
[warm up] executor &gt; local
executor &gt;  local (3)
[19/c2f873] process &gt; splitLetters   [100%] 1 of 1 
[05/5ff9f6] process &gt; convertToUpper [100%] 2 of 2 
HELLO
WORLD!</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the first process is executed once, and the second
twice. Finally the result string is printed.</p>
</div>
<div class="paragraph">
<p>It&#8217;s worth noting that the process <code>convertToUpper</code> is executed in
parallel, so there&#8217;s no guarantee that the instance processing the first
split (the chunk Hello) will be executed before before the one
processing the second split (the chunk world!).</p>
</div>
<div class="paragraph">
<p>Thus, it is perfectly possible that you will get the final result
printed out in a different order:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>WORLD!
HELLO</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The hexadecimal numbers, like <code>22/7548fa</code>, identify the unique process
execution. These numbers are also the prefix of the directories where each
process is executed. You can inspect the files produced by them changing to the directory
<code>$PWD/work</code> and using these numbers to find the process-specific
execution path.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modify_and_resume">2.3. Modify and resume</h3>
<div class="paragraph">
<p>Nextflow keeps track of all the processes executed in your pipeline. If
you modify some parts of your script, only the processes that are
actually changed will be re-executed. The execution of the processes
that are not changed will be skipped and the cached result used instead.</p>
</div>
<div class="paragraph">
<p>This helps a lot when testing or modifying part of your pipeline without
having to re-execute it from scratch.</p>
</div>
<div class="paragraph">
<p>For the sake of this tutorial, modify the <code>convertToUpper</code> process in
the previous example, replacing the process script with the string
<code>rev $x</code>, so that the process looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>process convertToUpper {

    input:
    file y from letters.flatten()

    output:
    stdout into result

    &quot;&quot;&quot;
    rev $y
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then save the file with the same name, and execute it by adding the
<code>-resume</code> option to the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>nextflow run hello.nf -resume</pre>
</div>
</div>
<div class="paragraph">
<p>It will print output similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>N E X T F L O W  ~  version 20.01.0
Launching `hello.nf` [naughty_tuckerman] - revision: 22eaa07be4
[warm up] executor &gt; local
executor &gt;  local (2)
[19/c2f873] process &gt; splitLetters   [100%] 1 of 1, cached: 1 
[a7/a410d3] process &gt; convertToUpper [100%] 2 of 2 
olleH
!dlrow</pre>
</div>
</div>
<div class="paragraph">
<p>You will see that the execution of the process <code>splitLetters</code> is
actually skipped (the process ID is the same), and its results are
retrieved from the cache. The second process is executed as expected,
printing the reversed strings.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The pipeline results are cached by default in the directory <code>$PWD/work</code>.
Depending on your script, this folder can take of lot of disk space.
If your are sure you won&#8217;t resume your pipeline execution, clean this folder periodically.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_pipeline_parameters">2.4. Pipeline parameters</h3>
<div class="paragraph">
<p>Pipeline parameters are simply declared by prepending to a variable name
the prefix <code>params</code>, separated by dot character. Their value can be
specified on the command line by prefixing the parameter name with a
double dash character, i.e. <code>--paramName</code></p>
</div>
<div class="paragraph">
<p>For the sake of this tutorial, you can try to execute the previous
example specifying a different input string parameter, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>nextflow run hello.nf --greeting 'Bonjour le monde!'</pre>
</div>
</div>
<div class="paragraph">
<p>The string specified on the command line will override the default value
of the parameter. The output will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>N E X T F L O W  ~  version 20.01.0
Launching `hello.nf` [wise_stallman] - revision: 22eaa07be4
[warm up] executor &gt; local
executor &gt;  local (4)
[48/e8315b] process &gt; splitLetters   [100%] 1 of 1 
[01/840ca7] process &gt; convertToUpper [100%] 3 of 3 
uojnoB
m el r
!edno</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_channels">3. Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Channels are a key data structure of Nextflow that allows the implementation
of reactive-functional oriented computational workflows based on the <a href="https://en.wikipedia.org/wiki/Dataflow_programming">Dataflow</a> programming paradigm.</p>
</div>
<div class="paragraph">
<p>They are used to logically connect tasks each other or to implement functional style data transformations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/channel-files.png" alt="channel files">
</div>
</div>
<div class="sect2">
<h3 id="_channel_types">3.1. Channel types</h3>
<div class="paragraph">
<p>Nextflow distinguish two different kinds of channels: <strong>queue</strong> channels and <strong>value</strong> channels.</p>
</div>
<div class="sect3">
<h4 id="_queue_channel">3.1.1. Queue channel</h4>
<div class="paragraph">
<p>A <em>queue</em> channel is a <em>asynchronous</em> unidirectional <em>FIFO</em> queue which connects two processes or operators.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What <em>asynchronous</em> means? That operations are non-blocking.</p>
</li>
<li>
<p>What <em>unidirectional</em> means? That data flow from a producer to a consumer.</p>
</li>
<li>
<p>What <em>FIFO</em> means? That the data is guaranteed to be delivered in the same order as it is produced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A queue channel is implicitly created by process output definitions or using channel factories methods
such as <a href="https://www.nextflow.io/docs/latest/channel.html#from">Channel.from</a> or <a href="https://www.nextflow.io/docs/latest/channel.html#frompath">Channel.fromPath</a>.</p>
</div>
<div class="paragraph">
<p>Try the following snippets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>ch = Channel.from(1,2,3)
println(ch)     <i class="conum" data-value="1"></i><b>(1)</b>
ch.view()       <i class="conum" data-value="2"></i><b>(2)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the built-in <code>println</code> function to print the <code>ch</code> variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply the <code>view</code> method to the <code>ch</code> channel, therefore prints each item emitted by the channels.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise">Exercise</h5>
<div class="paragraph">
<p>Try to execute this snippet, it will produce an error message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>ch = Channel.from(1,2,3)
ch.view()
ch.view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A queue channel can have one and exactly one producer and one and exactly one consumer.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_value_channels">3.1.2. Value channels</h4>
<div class="paragraph">
<p>A <strong>value</strong> channel a.k.a. singleton channel by definition is bound to a single value and it can be read unlimited times without consuming its content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>ch = Channel.value('Hello')
ch.view()
ch.view()
ch.view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Hello
Hello
Hello</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_channel_factories">3.2. Channel factories</h3>
<div class="sect3">
<h4 id="_value">3.2.1. value</h4>
<div class="paragraph">
<p>The <code>value</code> factory method is used to create a <em>value</em> channel. An optional not <code>null</code> argument
can be specified to bind the channel to a specific value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>ch1 = Channel.value()                 <i class="conum" data-value="1"></i><b>(1)</b>
ch2 = Channel.value( 'Hello there' )  <i class="conum" data-value="2"></i><b>(2)</b>
ch2 = Channel.value( [1,2,3,4,5] )    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates an <em>empty</em> value channel.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates a value channel and binds a string to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a value channel and binds a list object to it that will be emitted as a sole emission.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_from">3.2.2. from</h4>
<div class="paragraph">
<p>The factory <code>Channel.from</code> allows the creation of a queue channel with the values specified as argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>ch = Channel.from( 1, 3, 5, 7 )
ch.view{ &quot;value: $it&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line in this example creates a variable <code>ch</code> which holds a channel object. This channel emits the values specified as a parameter in the <code>from</code> method. Thus the second line will print the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>value: 1
value: 3
value: 5
value: 7</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Method <code>Channel.from</code> will be deprecated and replaced by <code>Channel.of</code> (see
  below).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_of">3.2.3. of</h4>
<div class="paragraph">
<p>The method <code>Channel.of</code> works in a similar manner to <code>Channel.from</code>, though it fixes
some inconsistent behavior of the latter and provides a better handling for range of values.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel
    .of(1..23, 'X', 'Y')
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromlist">3.2.4. fromList</h4>
<div class="paragraph">
<p>The method <code>Channel.fromList</code> creates a channel emitting the elements provided
by a list objects specified as argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>list = ['hello', 'world']

Channel
    .fromList(list)
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_frompath">3.2.5. fromPath</h4>
<div class="paragraph">
<p>The <code>fromPath</code> factory method create a queue channel emitting one or more files
matching the specified glob pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>Channel.fromPath( '/data/big/*.txt' )</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example creates a channel and emits as many items as there are files with <code>txt</code> extension in the <code>/data/big</code> folder. Each element is a file object implementing the <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Paths.html">Path</a> interface.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two asterisks, i.e. <code>**</code>, works like <code>*</code> but crosses directory boundaries. This syntax is generally used for matching complete paths. Curly brackets specify a collection of sub-patterns.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Available options</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">glob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> interprets characters <code>*</code>, <code>?</code>, <code>[]</code> and <code>{}</code> as glob wildcards, otherwise handles them as normal characters (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of paths returned, either <code>file</code>, <code>dir</code> or <code>any</code> (default: <code>file</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> includes hidden files in the resulting paths (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxDepth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of directory levels to visit (default: <code>no limit</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">followLinks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> it follows symbolic links during directories tree traversal, otherwise they are managed as files (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">relative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> returned paths are relative to the top-most common directory (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> throws an exception of the specified path do not exist in the file system (default: <code>false</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Learn more about the glob patterns syntax at <a href="https://docs.oracle.com/javase/tutorial/essential/io/fileOps.html#glob">this link</a>.</p>
</div>
<div class="sect4">
<h5 id="_exercise_2">Exercise</h5>
<div class="paragraph">
<p>Use the <code>Channel.fromPath</code> method to create a channel emitting all files with the suffix <code>.fq</code> in the <code>data/ggal/</code> and any subdirectory, then print the file name.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromfilepairs">3.2.6. fromFilePairs</h4>
<div class="paragraph">
<p>The <code>fromFilePairs</code> method creates a channel emitting the file pairs matching a glob pattern provided by the user. The matching files are emitted as tuples in which the first element is the grouping key of the matching pair and the second element is the list of files (sorted in lexicographical order).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel
    .fromFilePairs('/my/data/SRR*_{1,2}.fastq')
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will produce an output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[SRR493366, [/my/data/SRR493366_1.fastq, /my/data/SRR493366_2.fastq]]
[SRR493367, [/my/data/SRR493367_1.fastq, /my/data/SRR493367_2.fastq]]
[SRR493368, [/my/data/SRR493368_1.fastq, /my/data/SRR493368_2.fastq]]
[SRR493369, [/my/data/SRR493369_1.fastq, /my/data/SRR493369_2.fastq]]
[SRR493370, [/my/data/SRR493370_1.fastq, /my/data/SRR493370_2.fastq]]
[SRR493371, [/my/data/SRR493371_1.fastq, /my/data/SRR493371_2.fastq]]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The glob pattern must contain at least a star wildcard character.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Available options</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of paths returned, either <code>file</code>, <code>dir</code> or <code>any</code> (default: <code>file</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> includes hidden files in the resulting paths (default: <code>false</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxDepth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of directory levels to visit (default: <code>no limit</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">followLinks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> it follows symbolic links during directories tree traversal, otherwise they are managed as files (default: <code>true</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the number of files each emitted item is expected to hold (default: 2). Set to <code>-1</code> for any.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> the matching files are produced as sole elements in the emitted tuples (default: <code>false</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>true</code> throws an exception of the specified path do not exist in the file system (default: <code>false</code>)</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_exercise_3">Exercise</h5>
<div class="paragraph">
<p>Use the <code>fromFilePairs</code> method to create a channel emitting all pairs of fastq read in the <code>data/ggal/</code>
directory and print them.</p>
</div>
<div class="paragraph">
<p>Then use the <code>flat:true</code> option and compare the output with the previous execution.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fromsra">3.2.7. fromSRA</h4>
<div class="paragraph">
<p>The <code>Channel.fromSRA</code> method that makes it possible to query of <a href="https://www.ncbi.nlm.nih.gov/sra">NCBI SRA</a> archive and returns a channel emitting the FASTQ files matching the specified selection criteria.</p>
</div>
<div class="paragraph">
<p>The query can be project ID or accession number(s) supported by the
<a href="https://www.ncbi.nlm.nih.gov/books/NBK25499/#chapter4.ESearch">NCBI ESearch API</a>.
For example the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel
    .fromSRA('SRP043510')
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>[SRR1448794, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/004/SRR1448794/SRR1448794.fastq.gz]
[SRR1448795, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/005/SRR1448795/SRR1448795.fastq.gz]
[SRR1448792, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/002/SRR1448792/SRR1448792.fastq.gz]
[SRR1448793, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR144/003/SRR1448793/SRR1448793.fastq.gz]
[SRR1910483, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR191/003/SRR1910483/SRR1910483.fastq.gz]
[SRR1910482, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR191/002/SRR1910482/SRR1910482.fastq.gz]
(remaining omitted)</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple accession IDs can be specified using a list object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>ids = ['ERR908507', 'ERR908506', 'ERR908505']
Channel
    .fromSRA(ids)
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>[ERR908507, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908507/ERR908507_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908507/ERR908507_2.fastq.gz]]
[ERR908506, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908506/ERR908506_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908506/ERR908506_2.fastq.gz]]
[ERR908505, [ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908505/ERR908505_1.fastq.gz, ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR908/ERR908505/ERR908505_2.fastq.gz]]</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Read pairs are implicitly managed are returned as a list of files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s straightforward to use this channel as an input using the usual Nextflow
syntax. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre>params.accession = 'SRP043510'
reads = Channel.fromSRA(params.accession)

process fastqc {
    input:
    tuple sample_id, file(reads_file) from reads

    output:
    file(&quot;fastqc_${sample_id}_logs&quot;) into fastqc_ch

    script:
    &quot;&quot;&quot;
    mkdir fastqc_${sample_id}_logs
    fastqc -o fastqc_${sample_id}_logs -f fastq -q ${reads_file}
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code snippet above creates a channel containing 24 samples from a chromatin dynamics study and runs FASTQC on the resulting files.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processes">4. Processes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>process</em> is the basic Nextflow computing primitive to execute foreign function i.e. custom
scripts or tools.</p>
</div>
<div class="paragraph">
<p>The process definition starts with keyword the <code>process</code>, followed by process name and finally the process <code>body</code> delimited by curly brackets. The process body must contain a string which represents the command or, more generally, a script that is executed by it.</p>
</div>
<div class="paragraph">
<p>A basic process looks like the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>process sayHello {
  &quot;&quot;&quot;
  echo 'Hello world!'
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A process may contain five definition blocks, respectively: directives,
inputs, outputs, when clause and finally the process script. The syntax is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>process &lt; name &gt; {
  [ directives ]        <i class="conum" data-value="1"></i><b>(1)</b>
  input:                <i class="conum" data-value="2"></i><b>(2)</b>
  &lt; process inputs &gt;
  output:               <i class="conum" data-value="3"></i><b>(3)</b>
  &lt; process outputs &gt;
  when:                 <i class="conum" data-value="4"></i><b>(4)</b>
  &lt; condition &gt;
  [script|shell|exec]:  <i class="conum" data-value="5"></i><b>(5)</b>
  &lt; user script to be executed &gt;
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Zero, one or more process directives</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Zero, one or more process inputs</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Zero, one or more process outputs</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An optional boolean conditional to trigger the process execution</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command to be executed</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_script">4.1. Script</h3>
<div class="paragraph">
<p>The <code>script</code> block is a string statement that defines the command that is executed by the process to carry out its task.</p>
</div>
<div class="paragraph">
<p>A process contains one and only one script block, and it must be the last statement when the process contains input and output declarations.</p>
</div>
<div class="paragraph">
<p>The script block can be a simple string or multi-line string. The latter simplifies the writing of non trivial scripts
composed by multiple commands spanning over multiple lines. For example::</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>process example {
    script:
    &quot;&quot;&quot;
    blastp -db /data/blast -query query.fa -outfmt 6 &gt; blast_result
    cat blast_result | head -n 10 | cut -f 2 &gt; top_hits
    blastdbcmd -db /data/blast -entry_batch top_hits &gt; sequences
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the process command is interpreted as a <strong>Bash</strong> script. However any other scripting language can be used just simply starting the script with the corresponding <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">Shebang</a> declaration. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process pyStuff {
  script:
  &quot;&quot;&quot;
  #!/usr/bin/env python

  x = 'Hello'
  y = 'world!'
  print &quot;%s - %s&quot; % (x,y)
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This allows the compositing in the same workflow script of tasks using different programming languages which may better fit a particular job. However for large chunks of code is suggested to save them
into separate files and invoke them from the process script.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_script_parameters">4.1.1. Script parameters</h4>
<div class="paragraph">
<p>Process script can be defined dynamically using variable values like in other string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>params.data = 'World'

process foo {
  script:
  &quot;&quot;&quot;
  echo Hello $params.data
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A process script can contain any string format supported by the Groovy programming language.
This allows us to use string interpolation or multiline string as in the script above.
Refer to <a href="#_string_interpolation">String interpolation</a> for more information.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Since Nextflow uses the same Bash syntax for variable substitutions in strings, Bash environment variables need to be escaped using <code>\</code> character.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>process foo {
  script:
  &quot;&quot;&quot;
  echo &quot;The current directory is \$PWD&quot;
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to modify the above script using <code>$PWD</code> instead of <code>\$PWD</code> and  check the difference.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This can be tricky when the script uses many Bash variables. A possible alternative
is to use a script string delimited by single-quote characters</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>process bar {
  script:
  '''
  echo $PATH | tr : '\\n'
  '''
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>However this won&#8217;t allow any more the usage of Nextflow variables in the command script.</p>
</div>
<div class="paragraph">
<p>Another alternative is to use a <code>shell</code> statement instead of <code>script</code> which uses a different
syntax for Nextflow variable: <code>!{..}</code>. This allow to use both Nextflow and Bash variables in
the same script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>params.data = 'le monde'

process baz {
  shell:
  '''
  X='Bonjour'
  echo $X !{params.data}
  '''
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_conditional_script">4.1.2. Conditional script</h4>
<div class="paragraph">
<p>The process script can also be defined in a complete dynamic manner using a <code>if</code> statement or any other expression evaluating to string value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre>params.aligner = 'kallisto'

process foo {
  script:
  if( params.aligner == 'kallisto' )
    &quot;&quot;&quot;
    kallisto --reads /some/data.fastq
    &quot;&quot;&quot;
  else if( params.aligner == 'salmon' )
    &quot;&quot;&quot;
    salmon --reads /some/data.fastq
    &quot;&quot;&quot;
  else
    throw new IllegalArgumentException(&quot;Unknown aligner $params.aligner&quot;)
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_4">Exercise</h5>
<div class="paragraph">
<p>Write a custom function that given the aligner name as parameter returns the command
string to be executed. Then use this function as the process script body.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inputs">4.2. Inputs</h3>
<div class="paragraph">
<p>Nextflow processes are isolated from each other but can communicate between themselves sending values through channels.</p>
</div>
<div class="paragraph">
<p>Inputs implicitly determine the dependency and the parallel execution of the process.
The process execution is fired each time a <em>new</em> data is ready to be consumed from the input channel:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/channel-process.png" alt="channel process">
</div>
</div>
<div class="paragraph">
<p>The input block defines which channels the process is expecting to receive inputs data from. You can only define one input block at a time and it must contain one or more inputs declarations.</p>
</div>
<div class="paragraph">
<p>The input block follows the syntax shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow">input:
  &lt;input qualifier&gt; &lt;input name&gt; from &lt;source channel&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_input_values">4.2.1. Input values</h4>
<div class="paragraph">
<p>The <code>val</code> qualifier allows you to receive data of any type as input. It can be accessed in the process script by using the specified input name, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>num = Channel.from( 1, 2, 3 )

process basicExample {
  input:
  val x from num

  &quot;&quot;&quot;
  echo process job $x
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process is executed three times, each time a value is received from the channel num and used to process the script. Thus, it results in an output similar to the one shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process job 3
process job 1
process job 2</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The channel guarantees that items are delivered in the same order as they have been sent - but - since the process is executed in a parallel manner, there is no guarantee that they are processed in the same order as they are received.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_input_files">4.2.2. Input files</h4>
<div class="paragraph">
<p>The <code>file</code> qualifier allows the handling of file values in the process execution context. This means that
Nextflow will stage it in the process execution directory, and it can be access in the script by using the name specified in the input declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file 'sample.fastq' from reads
    script:
    &quot;&quot;&quot;
    your_command --reads sample.fastq
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The input file name can also be defined using a variable reference as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file sample from reads
    script:
    &quot;&quot;&quot;
    your_command --reads $sample
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same syntax it&#8217;s also able to handle more than one input file in the same execution.
Only change the channel composition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>reads = Channel.fromPath( 'data/ggal/*.fq' )

process foo {
    input:
    file sample from reads.collect()
    script:
    &quot;&quot;&quot;
    your_command --reads $sample
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When a process declares an input <code>file</code> the corresponding channel elements
must be <strong>file</strong> objects i.e. created with the <code>file</code> helper function from the file specific
channel factories e.g. <code>Channel.fromPath</code> or <code>Channel.fromFilePairs</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>params.genome = 'data/ggal/transcriptome.fa'

process foo {
    input:
    file genome from params.genome
    script:
    &quot;&quot;&quot;
    your_command --reads $genome
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code creates a temporary file named <code>input.1</code> with the string <code>data/ggal/transcriptome.fa</code> as content. That likely is not what you wanted to do.</p>
</div>
</div>
<div class="sect3">
<h4 id="_input_path">4.2.3. Input path</h4>
<div class="paragraph">
<p>As of version 19.10.0, Nextflow introduced a new <code>path</code> input qualifier that simplifies
the handling of cases such as the one shown above. In a nutshell the input <code>path</code> automatically
handles string values as file objects. The following example works as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>params.genome = &quot;$baseDir/data/ggal/transcriptome.fa&quot;

process foo {
    input:
    path genome from params.genome
    script:
    &quot;&quot;&quot;
    your_command --reads $genome
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The path qualifier should be preferred over file to handle process input files when using Nextflow 19.10.0 or later.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_5">Exercise</h5>
<div class="paragraph">
<p>Write a script that creates a channel containing  all read files matching the pattern <code>data/ggal/*_1.fq</code>
followed by a process that concatenates them into a single file and prints the first 20 lines.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_combine_input_channels">4.2.4. Combine input channels</h4>
<div class="paragraph">
<p>A key feature of processes is the ability to handle inputs from multiple channels. However it&#8217;s
important to understands how the content of channel and their semantic affect the execution
of a process.</p>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process foo {
  echo true
  input:
  val x from Channel.from(1,2,3)
  val y from Channel.from('a','b','c')
  script:
   &quot;&quot;&quot;
   echo $x and $y
   &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both channels emit three value, therefore the process is executed three times, each time with a different pair:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(1, a)</p>
</li>
<li>
<p>(2, b)</p>
</li>
<li>
<p>(3, c)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What is happening is that the process waits until there&#8217;s a complete input configuration i.e. it receives an input value from all the channels declared as input.</p>
</div>
<div class="paragraph">
<p>When this condition is verified, it consumes the input values coming from the respective channels, and spawns a task execution, then repeat the same logic until one or more channels have no more content.</p>
</div>
<div class="paragraph">
<p>This means channel values are consumed serially one after another and the first empty channel cause the process execution to stop even if there are other values in other channels.</p>
</div>
<div class="paragraph">
<p><strong>What does it happen when not all channels have the same cardinality (i.e. they emit a different number of elements)?</strong></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process foo {
  echo true
  input:
  val x from Channel.from(1,2)
  val y from Channel.from('a','b','c','d')
  script:
   &quot;&quot;&quot;
   echo $x and $y
   &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process is executed only two time, because when a channel has no more data to be processed it stops the process execution.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note however that <em>value</em> channel do not affect the process termination.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To better understand this behavior compare the previous example with the following one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process bar {
  echo true
  input:
  val x from Channel.value(1)
  val y from Channel.from('a','b','c')
  script:
   &quot;&quot;&quot;
   echo $x and $y
   &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_6">Exercise</h5>
<div class="paragraph">
<p>Write a process that is executed for each read file matching the pattern <code>data/ggal/*_1.fq</code> and
use the same <code>data/ggal/transcriptome.fa</code> in each execution.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_input_repeaters">4.2.5. Input repeaters</h4>
<div class="paragraph">
<p>The <code>each</code> qualifier allows you to repeat the execution of a process for each item in a collection, every time a new data is received. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>sequences = Channel.fromPath('data/prots/*.tfa')
methods = ['regular', 'expresso', 'psicoffee']

process alignSequences {
  input:
  path seq from sequences
  each mode from methods

  &quot;&quot;&quot;
  t_coffee -in $seq -mode $mode
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example every time a file of sequences is received as input by the process, it executes three tasks running an alignment with a different value for the <code>mode</code> option. This is useful when you need to repeat the same task for a given set of parameters.</p>
</div>
<div class="sect4">
<h5 id="_exercise_7">Exercise</h5>
<div class="paragraph">
<p>Extend the previous example so a task is executed for each read file matching the pattern <code>data/ggal/*_1.fq</code> and repeat the same task both with <code>salmon</code> and <code>kallisto</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_outputs">4.3. Outputs</h3>
<div class="paragraph">
<p>The <em>output</em> declaration block allows to define the channels used by the process to send out the results produced.</p>
</div>
<div class="paragraph">
<p>There can be defined at most one output block and it can contain one or more outputs declarations. The output block follows the syntax shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>output:
  &lt;output qualifier&gt; &lt;output name&gt; into &lt;target channel&gt;[,channel,..]</pre>
</div>
</div>
<div class="sect3">
<h4 id="_output_values">4.3.1. Output values</h4>
<div class="paragraph">
<p>The <code>val</code> qualifier allows to output a <em>value</em> defined in the script context. In a common usage scenario,
this is a value which has been defined in the <em>input</em> declaration block, as shown in the following example::</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre>methods = ['prot','dna', 'rna']

process foo {
  input:
  val x from methods

  output:
  val x into receiver

  &quot;&quot;&quot;
  echo $x &gt; file
  &quot;&quot;&quot;
}

receiver.view { &quot;Received: $it&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_output_files">4.3.2. Output files</h4>
<div class="paragraph">
<p>The <code>file</code> qualifier allows to output one or more files, produced by the process, over the specified channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre>process randomNum {

    output:
    file 'result.txt' into numbers

    '''
    echo $RANDOM &gt; result.txt
    '''
}

numbers.view { &quot;Received: &quot; + it.text }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the process <code>randomNum</code> creates a file named <code>result.txt</code> containing a random number.</p>
</div>
<div class="paragraph">
<p>Since a file parameter using the same name is declared in the output block, when the task is completed that
file is sent over the <code>numbers</code> channel. A downstream <code>process</code> declaring the same channel as <em>input</em> will
be able to receive it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_output_files">4.3.3. Multiple output files</h4>
<div class="paragraph">
<p>When an output file name contains a <code>*</code> or <code>?</code> wildcard character it is interpreted as a
<a href="http://docs.oracle.com/javase/tutorial/essential/io/fileOps.html#glob">glob</a> path matcher.
This allows to <em>capture</em> multiple files into a list object and output them as a sole emission. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre>process splitLetters {

    output:
    file 'chunk_*' into letters

    '''
    printf 'Hola' | split -b 1 - chunk_
    '''
}

letters
    .flatMap()
    .view { &quot;File: ${it.name} =&gt; ${it.text}&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>it prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>File: chunk_aa =&gt; H
File: chunk_ab =&gt; o
File: chunk_ac =&gt; l
File: chunk_ad =&gt; a</pre>
</div>
</div>
<div class="paragraph">
<p>Some caveats on glob pattern behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Input files are not included in the list of possible matches.</p>
</li>
<li>
<p>Glob pattern matches against both files and directories path.</p>
</li>
<li>
<p>When a two stars pattern <code>**</code> is used to recourse across directories, only file paths are matched
i.e. directories are not included in the result list.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_exercise_8">Exercise</h5>
<div class="paragraph">
<p>Remove the <code>flatMap</code> operator and see out the output change. The documentation
for the <code>flatMap</code> operator is available at <a href="https://www.nextflow.io/docs/latest/operator.html#flatmap">this link</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_output_file_names">4.3.4. Dynamic output file names</h4>
<div class="paragraph">
<p>When an output file name needs to be expressed dynamically, it is possible to define it using a dynamic evaluated
string which references values defined in the input declaration block or in the script global context.
For example::</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>process align {
  input:
  val x from species
  file seq from sequences

  output:
  file &quot;${x}.aln&quot; into genomes

  &quot;&quot;&quot;
  t_coffee -in $seq &gt; ${x}.aln
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, each time the process is executed an alignment file is produced whose name depends
on the actual value of the <code>x</code> input.</p>
</div>
</div>
<div class="sect3">
<h4 id="_composite_inputs_and_outputs">4.3.5. Composite inputs and outputs</h4>
<div class="paragraph">
<p>So far we have seen how to declare multiple input and output channels, but each channel was handling
only one value at time. However Nextflow can handle tuple of values.</p>
</div>
<div class="paragraph">
<p>When using channel emitting tuple of values the corresponding input declaration must be declared with a <code>tuple</code> qualifier followed by definition of each single element in the tuple.</p>
</div>
<div class="paragraph">
<p>In the same manner output channel emitting tuple of values can be declared using the <code>tuple</code> qualifier
following by the definition of each tuple element in the tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>reads_ch = Channel.fromFilePairs('data/ggal/*_{1,2}.fq')

process foo {
  input:
    tuple val(sample_id), file(sample_files) from reads_ch
  output:
    tuple val(sample_id), file('sample.bam') into bam_ch
  script:
  &quot;&quot;&quot;
    your_command_here --reads $sample_id &gt; sample.bam
  &quot;&quot;&quot;
}

bam_ch.view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In previous versions of Nextflow <code>tuple</code> was called <code>set</code> but it was used exactly with the
  same semantic. It can still be used for backward compatibility.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_9">Exercise</h5>
<div class="paragraph">
<p>Modify the script of the previous exercise so that the <em>bam</em> file is named as the given <code>sample_id</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_when">4.4. When</h3>
<div class="paragraph">
<p>The <code>when</code> declaration allows you to define a condition that must be verified in order to execute the process. This can be any expression that evaluates a boolean value.</p>
</div>
<div class="paragraph">
<p>It is useful to enable/disable the process execution depending the state of various inputs and parameters. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre>params.dbtype = 'nr'
params.prot = 'data/prots/*.tfa'
proteins = Channel.fromPath(params.prot)

process find {
  input:
  file fasta from proteins
  val type from params.dbtype

  when:
  fasta.name =~ /^BB11.*/ &amp;&amp; type == 'nr'

  script:
  &quot;&quot;&quot;
  blastp -query $fasta -db nr
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_directives">4.5. Directives</h3>
<div class="paragraph">
<p>Directive declarations allow the definition of optional settings that affect the execution of the current process without affecting the <em>semantic</em> of the task itself.</p>
</div>
<div class="paragraph">
<p>They must be entered at the top of the process body, before any other declaration blocks (i.e. <code>input</code>, <code>output</code>, etc).</p>
</div>
<div class="paragraph">
<p>Directives are commonly used to define the amount of computing resources to be used or
other meta directives like that allows the definition of extra information for configuration or
logging purpose. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process foo {
  cpus 2
  memory 8.GB
  container 'image/name'

  script:
  &quot;&quot;&quot;
  your_command --this --that
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete list of directives is available <a href="https://www.nextflow.io/docs/latest/process.html#directives">at this link</a>.</p>
</div>
<div class="sect3">
<h4 id="_exercise_10">4.5.1. Exercise</h4>
<div class="paragraph">
<p>Modify the script of the previous exercise adding a <a href="https://www.nextflow.io/docs/latest/process.html#tag">tag</a> directive logging the <code>sample_id</code> in the execution output.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_organise_outputs">4.6. Organise outputs</h3>
<div class="sect3">
<h4 id="_publishdir_directive">4.6.1. PublishDir directive</h4>
<div class="paragraph">
<p>Nextflow manages independently workflow execution intermediate results
from the pipeline expected outputs. Task output files are created in the
task specific execution directory which is considered as a temporary directory
that can be deleted upon completion.</p>
</div>
<div class="paragraph">
<p>The pipeline result files need to be marked explicitly using the directive
<a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> in
the process that&#8217;s creating such file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>process makeBams {
    publishDir &quot;/some/directory/bam_files&quot;, mode: 'copy'

    input:
    file index from index_ch
    tuple val(name), file(reads) from reads_ch

    output:
    tuple val(name), file ('*.bam') into star_aligned

    &quot;&quot;&quot;
    STAR --genomeDir $index --readFilesIn $reads
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will copy all bam files created by the <code>star</code> task in the
directory path <code>/some/directory/bam_files</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The publish directory can be local or remote. For example output files
could be stored to a <a href="https://aws.amazon.com/s3/">AWS S3 bucket</a> just using the <code>s3://</code> prefix in the target path.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_manage_semantic_sub_directories">4.6.2. Manage semantic sub-directories</h4>
<div class="paragraph">
<p>You can use more then one <code>publishDir</code> to keep different outputs in separate directory. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
  <td class="code"><pre>params.reads = 'data/reads/*_{1,2}.fq.gz'
params.outdir = 'my-results'

Channel
    .fromFilePairs(params.reads, flat: true)
    .set{ samples_ch }

process foo {
  publishDir &quot;$params.outdir/$sampleId/&quot;, pattern: '*.fq'
  publishDir &quot;$params.outdir/$sampleId/counts&quot;, pattern: &quot;*_counts.txt&quot;
  publishDir &quot;$params.outdir/$sampleId/outlooks&quot;, pattern: '*_outlook.txt'

  input:
    set sampleId, file('sample1.fq.gz'), file('sample2.fq.gz') from samples_ch
  output:
    file &quot;*&quot;
  script:
  &quot;&quot;&quot;
    &lt; sample1.fq.gz zcat &gt; sample1.fq
    &lt; sample2.fq.gz zcat &gt; sample2.fq

    awk '{s++}END{print s/4}' sample1.fq &gt; sample1_counts.txt
    awk '{s++}END{print s/4}' sample2.fq &gt; sample2_counts.txt

    head -n 50 sample1.fq &gt; sample1_outlook.txt
    head -n 50 sample2.fq &gt; sample2_outlook.txt
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will create an output structure in the directory <code>my-results</code>,
which contains a separate sub-directory for each given sample ID each of which
contain the folders <code>counts</code> and <code>outlooks</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operators">5. Operators</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Built-in functions applied to channels</p>
</li>
<li>
<p>Transform channels content</p>
</li>
<li>
<p>Can be used also to filter, fork and combine channels</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_basic_example">5.1. Basic example</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>nums = Channel.from(1,2,3,4)         <i class="conum" data-value="1"></i><b>(1)</b>
square = nums.map { it -&gt; it * it }  <i class="conum" data-value="2"></i><b>(2)</b>
square.view()                        <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/channel-map.png" alt="channel map">
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a queue channel emitting four values.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a new channels transforming each number in it&#8217;s square.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Print the channel content.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Operators can be chained to implement custom behaviors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel.from(1,2,3,4)
        .map { it -&gt; it * it }
        .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Operators can be separated in to five groups:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filtering operators</p>
</li>
<li>
<p>Transforming operators</p>
</li>
<li>
<p>Splitting operators</p>
</li>
<li>
<p>Combining operators</p>
</li>
<li>
<p>Forking operators</p>
</li>
<li>
<p>Maths operators</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_basic_operators">5.2. Basic operators</h3>
<div class="sect3">
<h4 id="_view">5.2.1. view</h4>
<div class="paragraph">
<p>The <code>view</code> operator prints the items emitted by a channel to the console standard output appending a
<em>new line</em> character to each of them. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel
      .from('foo', 'bar', 'baz')
      .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>foo
bar
baz</code></pre>
</div>
</div>
<div class="paragraph">
<p>An optional <em>closure</em> parameter can be specified to customize how items are printed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel
      .from('foo', 'bar', 'baz')
      .view { &quot;- $it&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- foo
- bar
- baz</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_map">5.2.2. map</h4>
<div class="paragraph">
<p>The <code>map</code> operator applies a function of your choosing to every item emitted by a channel, and returns the items so obtained as a new channel. The function applied is called the <em>mapping</em> function and is expressed with a <em>closure</em> as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>Channel
    .from( 'hello', 'world' )
    .map { it -&gt; it.reverse() }
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>map</code> can associate to each element a generic <em>tuple</em> containing any data as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>Channel
    .from( 'hello', 'world' )
    .map { word -&gt; [word, word.size()] }
    .view { word, len -&gt; &quot;$word contains $len letters&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_11">Exercise</h5>
<div class="paragraph">
<p>Use <code>fromPath</code> to create a channel emitting the <em>fastq</em> files matching the pattern <code>data/ggal/*.fq</code>,
then chain with a map to return a pair containing the file name and the path itself.
Finally print the resulting channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>Channel.fromPath('data/ggal/*.fq')
        .map { file -&gt; [ file.name, file ] }
        .view { name, file -&gt; &quot;&gt; file: $name&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_into">5.2.3. into</h4>
<div class="paragraph">
<p>The <code>into</code> operator connects a source channel to two or more target channels in such a way the values emitted by the source channel are copied to the target channels. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>Channel
     .from( 'a', 'b', 'c' )
     .into{ foo; bar }

foo.view{ &quot;Foo emits: &quot; + it }
bar.view{ &quot;Bar emits: &quot; + it }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note the use in this example of curly brackets and the <code>;</code> as channel names separator. This is needed because the actual parameter of into is a <em>closure</em> which defines the target channels to which the source one is connected.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mix">5.2.4. mix</h4>
<div class="paragraph">
<p>The <code>mix</code> operator combines the items emitted by two (or more) channels into a single channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>c1 = Channel.from( 1,2,3 )
c2 = Channel.from( 'a','b' )
c3 = Channel.from( 'z' )

c1 .mix(c2,c3).view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1
2
a
3
b
z</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The items in the resulting channel have the same order as in respective original channel,
however there&#8217;s no guarantee that the element of the second channel are append after the elements
of the first. Indeed in the above example the element <code>a</code> has been printed before <code>3</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_flatten">5.2.5. flatten</h4>
<div class="paragraph">
<p>The <code>flatten</code> operator transforms a channel in such a way that every <em>tuple</em> is flattened so that each single entry is emitted as a sole element by the resulting channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>foo = [1,2,3]
bar = [4, 5, 6]

Channel
    .from(foo, bar)
    .flatten()
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above snippet prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1
2
3
4
5
6</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collect">5.2.6. collect</h4>
<div class="paragraph">
<p>The <code>collect</code> operator collects all the items emitted by a channel to a list and return the resulting object as a sole emission.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>Channel
    .from( 1, 2, 3, 4 )
    .collect()
    .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints a single value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[1,2,3,4]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The result of the <code>collect</code> operator is a <strong>value</strong> channel.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_grouptuple">5.2.7. groupTuple</h4>
<div class="paragraph">
<p>The <code>groupTuple</code> operator collects tuples (or lists) of values emitted by the source channel grouping together the elements that share the same key. Finally it emits a new tuple object for each distinct key collected.</p>
</div>
<div class="paragraph">
<p>Try the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>Channel
     .from( [1,'A'], [1,'B'], [2,'C'], [3, 'B'], [1,'C'], [2, 'A'], [3, 'D'] )
     .groupTuple()
     .view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[1, [A, B, C]]
[2, [C, A]]
[3, [B, D]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This operator is useful to process altogether all elements for which there&#8217;s a common
property or a grouping key.</p>
</div>
<div class="sect4">
<h5 id="_exercise_12">Exercise</h5>
<div class="paragraph">
<p>Use <code>fromPath</code> to create a channel emitting the <em>fastq</em> files matching the pattern <code>data/ggal/*.fq</code>,
then use a <code>map</code> to associate to each file the name prefix. Finally group together all
files having the same common prefix.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_join">5.2.8. join</h4>
<div class="paragraph">
<p>The <code>join</code> operator creates a channel that joins together the items emitted by two channels for which exits a matching key. The key is defined, by default, as the first element in each item emitted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>left = Channel.from(['X', 1], ['Y', 2], ['Z', 3], ['P', 7])
right= Channel.from(['Z', 6], ['Y', 5], ['X', 4])
left.join(right).view()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting channel emits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[Z, 3, 6]
[Y, 2, 5]
[X, 1, 4]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_branch">5.2.9. branch</h4>
<div class="paragraph">
<p>The <code>branch</code> operator allows you to forward the items emitted by a source channel to one or more output channels, choosing one out of them at a time.</p>
</div>
<div class="paragraph">
<p>The selection criteria is defined by specifying a closure that provides one or more boolean expression, each of which is identified by a unique label. On the first expression that evaluates to a true value, the current item is bound to a named channel as the label identifier.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>Channel
    .from(1,2,3,40,50)
    .branch {
        small: it &lt; 10
        large: it &gt; 10
    }
    .set { result }

 result.small.view { &quot;$it is small&quot; }
 result.large.view { &quot;$it is large&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>branch</code> operator returns a multi-channel object i.e. a variable that holds
more than one channel object.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources">5.3. More resources</h3>
<div class="paragraph">
<p>Check the <a href="https://www.nextflow.io/docs/latest/operator.html">operators documentation</a> on Nextflow web site.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_groovy_basic_structures_and_idioms">6. Groovy basic structures and idioms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nextflow is a DSL implemented on top of the Groovy programming lang, which in turns is a super-set of the Java programming language. This means that Nextflow can run any Groovy and Java code.</p>
</div>
<div class="sect2">
<h3 id="_printing_values">6.1. Printing values</h3>
<div class="paragraph">
<p>To print something is as easy as using one of the <code>print</code> or <code>println</code> methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello, World!</span><span class="delimiter">&quot;</span></span>)</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only difference between the two is that the <code>println</code> method implicitly appends a new line character to the printed string.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
parenthesis for function invocations are optional. Therefore also the following is a valid
syntax.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>println <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello, World!</span><span class="delimiter">&quot;</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comments">6.2. Comments</h3>
<div class="paragraph">
<p>Comments use the same syntax as in the C-family programming languages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="comment">// comment a single config file</span>

<span class="comment">/*
   a comment spanning
   multiple lines
 */</span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variables">6.3. Variables</h3>
<div class="paragraph">
<p>To define a variable, simply assign a value to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>x = <span class="integer">1</span>
println x

x = <span class="keyword">new</span> java.util.Date()
println x

x = -<span class="float">3.1499392</span>
println x

x = <span class="predefined-constant">false</span>
println x

x = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hi</span><span class="delimiter">&quot;</span></span>
println x</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Local variables are defined using the <code>def</code> keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> x = <span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It should be always used when defining variables local to a function or a closure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_lists">6.4. Lists</h3>
<div class="paragraph">
<p>A List object can be defined by placing the list items in square brackets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>list = [<span class="integer">10</span>,<span class="integer">20</span>,<span class="integer">30</span>,<span class="integer">40</span>]</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can access a given item in the list with square-bracket notation (indexes start at <code>0</code>)
or using the <code>get</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="keyword">assert</span> list[<span class="integer">0</span>] == <span class="integer">10</span>
<span class="keyword">assert</span> list[<span class="integer">0</span>] == list.get(<span class="integer">0</span>)</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to get the length of the list use the size method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="keyword">assert</span> list.size() == <span class="integer">4</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lists can also be indexed with negative indexes and reversed ranges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>list = [<span class="integer">0</span>,<span class="integer">1</span>,<span class="integer">2</span>]
<span class="keyword">assert</span> list[-<span class="integer">1</span>] == <span class="integer">2</span>
<span class="keyword">assert</span> list[-<span class="integer">1</span>..<span class="integer">0</span>] == list.reverse()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>List objects implements all methods provided by the Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html">java.util.List</a> interface
plus the extension methods provided by <a href="http://docs.groovy-lang.org/latest/html/groovy-jdk/java/util/List.html">Groovy API</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>] &lt;&lt; <span class="integer">1</span> == [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>] + [<span class="integer">1</span>] == [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>] - [<span class="integer">1</span>] == [<span class="integer">2</span>,<span class="integer">3</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>] * <span class="integer">2</span> == [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,[<span class="integer">2</span>,<span class="integer">3</span>]].flatten() == [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>].reverse() == [<span class="integer">3</span>,<span class="integer">2</span>,<span class="integer">1</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>].collect{ <span class="local-variable">it</span>+<span class="integer">3</span> } == [<span class="integer">4</span>,<span class="integer">5</span>,<span class="integer">6</span>]
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>].unique().size() == <span class="integer">3</span>
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">1</span>].count(<span class="integer">1</span>) == <span class="integer">2</span>
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>].min() == <span class="integer">1</span>
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>].max() == <span class="integer">4</span>
<span class="keyword">assert</span> [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>].sum() == <span class="integer">10</span>
<span class="keyword">assert</span> [<span class="integer">4</span>,<span class="integer">2</span>,<span class="integer">1</span>,<span class="integer">3</span>].sort() == [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>]
<span class="keyword">assert</span> [<span class="integer">4</span>,<span class="integer">2</span>,<span class="integer">1</span>,<span class="integer">3</span>].find{<span class="local-variable">it</span>%<span class="integer">2</span> == <span class="integer">0</span>} == <span class="integer">4</span>
<span class="keyword">assert</span> [<span class="integer">4</span>,<span class="integer">2</span>,<span class="integer">1</span>,<span class="integer">3</span>].findAll{<span class="local-variable">it</span>%<span class="integer">2</span> == <span class="integer">0</span>} == [<span class="integer">4</span>,<span class="integer">2</span>]</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maps">6.5. Maps</h3>
<div class="paragraph">
<p>Maps are like lists that have an arbitrary type of key instead of integer. Therefore, the syntax is very much aligned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>map = [<span class="key">a</span>:<span class="integer">0</span>, <span class="key">b</span>:<span class="integer">1</span>, <span class="key">c</span>:<span class="integer">2</span>]</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maps can be accessed in a conventional square-bracket syntax or as if the key was a property of the map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">assert</span> map[<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>] == <span class="integer">0</span>        <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">assert</span> map.b == <span class="integer">1</span>           <i class="conum" data-value="2"></i><b>(2)</b>
<span class="keyword">assert</span> map.get(<span class="string"><span class="delimiter">'</span><span class="content">c</span><span class="delimiter">'</span></span>) == <span class="integer">2</span>    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use of the square brackets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a dot notation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use of get method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add data or to modify a map, the syntax is similar to adding values to list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>map[<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>] = <span class="string"><span class="delimiter">'</span><span class="content">x</span><span class="delimiter">'</span></span>           <i class="conum" data-value="1"></i><b>(1)</b>
map.b = <span class="string"><span class="delimiter">'</span><span class="content">y</span><span class="delimiter">'</span></span>              <i class="conum" data-value="2"></i><b>(2)</b>
map.put(<span class="string"><span class="delimiter">'</span><span class="content">c</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">z</span><span class="delimiter">'</span></span>)        <i class="conum" data-value="3"></i><b>(3)</b>
<span class="keyword">assert</span> map == [<span class="key">a</span>:<span class="string"><span class="delimiter">'</span><span class="content">x</span><span class="delimiter">'</span></span>, <span class="key">b</span>:<span class="string"><span class="delimiter">'</span><span class="content">y</span><span class="delimiter">'</span></span>, <span class="key">c</span>:<span class="string"><span class="delimiter">'</span><span class="content">z</span><span class="delimiter">'</span></span>]</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use of the square brackets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a dot notation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use of get method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Map objects implements all methods provided by the Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a> interface
plus the extension methods provided by <a href="http://docs.groovy-lang.org/latest/html/groovy-jdk/java/util/Map.html">Groovy API</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_string_interpolation">6.6. String interpolation</h3>
<div class="paragraph">
<p>String literals can be defined enclosing them either with single-quoted or double-quotes characters.</p>
</div>
<div class="paragraph">
<p>Double-quoted strings can contain the value of an arbitrary variable by prefixing its name with the $ character, or the value of any expression by using the ${expression} syntax, similar to Bash/shell scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>foxtype = <span class="string"><span class="delimiter">'</span><span class="content">quick</span><span class="delimiter">'</span></span>
foxcolor = [<span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">r</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">o</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">n</span><span class="delimiter">'</span></span>]
println <span class="string"><span class="delimiter">&quot;</span><span class="content">The </span><span class="inline"><span class="inline-delimiter">$</span>foxtype</span><span class="content"> </span><span class="inline"><span class="inline-delimiter">${</span>foxcolor.join()<span class="inline-delimiter">}</span></span><span class="content"> fox</span><span class="delimiter">&quot;</span></span>

x = <span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span>
println <span class="string"><span class="delimiter">'</span><span class="content">$x + $y</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>The quick brown fox
<span class="error">$</span>x + <span class="error">$</span>y</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note the different use of <code>$</code> and <code>${..}</code> syntax to interpolate value expressions in a string literal.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally string literals can also be defined using the <code>/</code> character as delimiter. They are known as
<strong>slashy</strong> strings and are useful for defining regular expressions and patterns, as there is no need to escape backslashes. As with double quote strings they allow to interpolate variables prefixed with a <code>$</code>
character.</p>
</div>
<div class="paragraph">
<p>Try the following to see the difference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>x = <span class="regexp"><span class="delimiter">/</span><span class="content">tic</span><span class="char">\t</span><span class="content">ac</span><span class="char">\t</span><span class="content">oe</span><span class="delimiter">/</span></span>
y = <span class="string"><span class="delimiter">'</span><span class="content">tic\tac\toe</span><span class="delimiter">'</span></span>

println x
println y</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>it prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>tic\tac\toe
tic    ac    oe</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_line_strings">6.7. Multi-line strings</h3>
<div class="paragraph">
<p>A block of text that span multiple lines can be defined by delimiting it with triple single or double quotes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>text = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
    Hello there James
    how are you today?
    </span><span class="delimiter">&quot;&quot;&quot;</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally multi-line strings can also be defined with slashy string. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>text = <span class="regexp"><span class="delimiter">/</span></span><span class="error">
</span>    This is a multi-line
    slashy string!
    It<span class="string"><span class="delimiter">'</span><span class="content">s cool, isn</span><span class="delimiter">'</span></span>t <span class="local-variable">it</span>?!
    <span class="regexp"><span class="delimiter">/</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Like before, multi-line strings inside double quotes and slash characters support variable interpolation, while single-quoted multi-line strings do not.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_if_statement">6.8. If statement</h3>
<div class="paragraph">
<p>The <code>if</code> statement uses the same syntax common other programming lang such Java, C, JavaScript, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">if</span>( &lt; <span class="type">boolean</span> expression &gt; ) {
    <span class="comment">// true branch</span>
}
<span class="keyword">else</span> {
    <span class="comment">// false branch</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>else</code> branch is optional. Also curly brackets are optional when the branch define just a single
statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>x = <span class="integer">1</span>
<span class="keyword">if</span>( x &gt; <span class="integer">10</span> )
    println <span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>null</code>, empty strings and empty collections are evaluated to <code>false</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Therefore a statement like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>list = [<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>]
<span class="keyword">if</span>( list != <span class="predefined-constant">null</span> &amp;&amp; list.size() &gt; <span class="integer">0</span> ) {
  println list
}
<span class="keyword">else</span> {
  println <span class="string"><span class="delimiter">'</span><span class="content">The list is empty</span><span class="delimiter">'</span></span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Can be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre><span class="keyword">if</span>( list )
    println list
<span class="keyword">else</span>
    println <span class="string"><span class="delimiter">'</span><span class="content">The list is empty</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="http://groovy-lang.org/semantics.html#Groovy-Truth">Groovy-Truth</a> for details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some cases can be useful to replace <code>if</code> statement with a ternary expression aka
conditional expression. For example:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>println list ? list : <span class="string"><span class="delimiter">'</span><span class="content">The list is empty</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous statement can be further simplified using the <a href="http://groovy-lang.org/operators.html#_elvis_operator">Elvis operator</a> as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>println list ?: <span class="string"><span class="delimiter">'</span><span class="content">The list is empty</span><span class="delimiter">'</span></span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_for_statement">6.9. For statement</h3>
<div class="paragraph">
<p>The classical <code>for</code> loop syntax is supported as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt;<span class="integer">3</span>; i++) {
   println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World </span><span class="inline"><span class="inline-delimiter">$</span>i</span><span class="delimiter">&quot;</span></span>)
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iteration over list objects is also possible using the syntax below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>list = [<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">c</span><span class="delimiter">'</span></span>]

<span class="keyword">for</span>( <span class="predefined-type">String</span> elem : list ) {
  println elem
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions">6.10. Functions</h3>
<div class="paragraph">
<p>It is possible to define a custom function into a script, as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="type">int</span> fib(<span class="type">int</span> n) {
    <span class="keyword">return</span> n &lt; <span class="integer">2</span> ? <span class="integer">1</span> : fib(n-<span class="integer">1</span>) + fib(n-<span class="integer">2</span>)
}

<span class="keyword">assert</span> fib(<span class="integer">10</span>)==<span class="integer">89</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A function can take multiple arguments separating them with a comma. The <code>return</code>
keyword can be omitted and the function implicitly returns the value
of the last evaluated expression. Also explicit types can be omitted (thought not recommended):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">fact</span>( n ) {
  n &gt; <span class="integer">1</span> ? n * fact(n-<span class="integer">1</span>) : <span class="integer">1</span>
}

<span class="keyword">assert</span> fact(<span class="integer">5</span>) == <span class="integer">120</span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closures">6.11. Closures</h3>
<div class="paragraph">
<p>Closures are the swiss army knife of Nextflow/Groovy programming. In a nutshell a closure is
is a block of code that can be passed as an argument to a function, it could also be defined
an anonymous function.</p>
</div>
<div class="paragraph">
<p>More formally, a closure allows the definition of functions as first class objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>square = { <span class="local-variable">it</span> * <span class="local-variable">it</span> }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The curly brackets around the expression <code>it * it</code> tells the script interpreter to treat this expression as code. The <code>it</code> identifier is an implicit variable that represents the value that is passed to the function when it is invoked.</p>
</div>
<div class="paragraph">
<p>Once compiled the function object is assigned to the variable <code>square</code> as any other variable assignments shown previously. To invoke the closure execution use the special method <code>call</code> or just use the round
parentheses to specify the closure parameter(s). For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="keyword">assert</span> square.call(<span class="integer">5</span>) == <span class="integer">25</span>
<span class="keyword">assert</span> square(<span class="integer">9</span>) == <span class="integer">81</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is not very interesting until we find that we can pass the function <code>square</code> as an argument to other functions or methods.
Some built-in functions take a function like this as an argument. One example is the <code>collect</code> method on lists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>x = [ <span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span> ].collect(square)
println x</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[ 1, 4, 9, 16 ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, closures take a single parameter called <code>it</code>, to give it a different name use the
<code>-&gt;</code> syntax. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>square = { num -&gt; num * num }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to define closures with multiple, custom-named parameters.</p>
</div>
<div class="paragraph">
<p>For example, the method <code>each()</code> when applied to a map can take a closure with two arguments,
to which it passes the <em>key-value</em> pair for each entry in the map object. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>printMap = { a, b -&gt; println <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>a</span><span class="content"> with value </span><span class="inline"><span class="inline-delimiter">$</span>b</span><span class="delimiter">&quot;</span></span> }
values = [ <span class="string"><span class="delimiter">&quot;</span><span class="content">Yue</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Wu</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Mark</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Williams</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Sudha</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Kumari</span><span class="delimiter">&quot;</span></span> ]
values.each(printMap)</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It prints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Yue with value Wu
Mark with value Williams
Sudha with value Kumari</code></pre>
</div>
</div>
<div class="paragraph">
<p>A closure has two other important features. First, it can access and <em>modify</em> variables in the scope
where it is defined.</p>
</div>
<div class="paragraph">
<p>Second, a closure can be defined in an <em>anonymous</em> manner, meaning that it is not given a name,
and is defined in the place where it needs to be used.</p>
</div>
<div class="paragraph">
<p>As an example showing both these features, see the following code fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>result = <span class="integer">0</span>  <i class="conum" data-value="1"></i><b>(1)</b>
values = [<span class="string"><span class="delimiter">&quot;</span><span class="content">China</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span> , <span class="string"><span class="delimiter">&quot;</span><span class="content">India</span><span class="delimiter">&quot;</span></span> : <span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">USA</span><span class="delimiter">&quot;</span></span> : <span class="integer">3</span>]   <i class="conum" data-value="2"></i><b>(2)</b>
values.keySet().each { result += values[<span class="local-variable">it</span>] }    <i class="conum" data-value="3"></i><b>(3)</b>
println result</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a global variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a map object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Invoke the <code>each</code> method passing closure object which modifies the <code>result</code> variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Learn more about closures in the <a href="http://groovy-lang.org/closures.html">Groovy documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources_2">6.12. More resources</h3>
<div class="paragraph">
<p>The complete Groovy language documentation is available at <a href="http://groovy-lang.org/documentation.html#languagespecification">this link</a>.</p>
</div>
<div class="paragraph">
<p>A great resource to master Apache Groovy syntax is <a href="https://www.manning.com/books/groovy-in-action-second-edition">Groovy in Action</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_rna_seq_pipeline">7. Simple Rna-Seq pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During this tutorial you will implement a proof of concept of a RNA-Seq pipeline which:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Indexes a trascriptome file.</p>
</li>
<li>
<p>Performs quality controls</p>
</li>
<li>
<p>Performs quantification.</p>
</li>
<li>
<p>Create a MultiqQC report.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_define_the_pipeline_parameters">7.1. Define the pipeline parameters</h3>
<div class="paragraph">
<p>The script <code>script1.nf</code> defines the pipeline input parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>params.reads = &quot;$baseDir/data/ggal/*_{1,2}.fq&quot;
params.transcriptome = &quot;$baseDir/data/ggal/transcriptome.fa&quot;
params.multiqc = &quot;$baseDir/multiqc&quot;

println &quot;reads: $params.reads&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it by using the
following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script1.nf</pre>
</div>
</div>
<div class="paragraph">
<p>Try to specify a different input parameter, for example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script1.nf --reads this/and/that</pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_13">7.1.1. Exercise</h4>
<div class="paragraph">
<p>Modify the <code>script1.nf</code> adding a fourth parameter named <code>outdir</code> and set it to a default path
that will be used as the pipeline output directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_14">7.1.2. Exercise</h4>
<div class="paragraph">
<p>Modify the <code>script1.nf</code> to print all the pipeline parameters by using a single <code>log.info</code> command and a <a href="https://www.nextflow.io/docs/latest/script.html#multi-line-strings">multiline string</a> statement.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See an example <a href="https://github.com/nextflow-io/rnaseq-nf/blob/3b5b49f/main.nf#L41-L48" target="_blank" rel="noopener">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap">7.1.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to define parameters in your pipeline script</p>
</li>
<li>
<p>How to pass parameters by using the command line</p>
</li>
<li>
<p>The use of <code>$var</code> and <code>${var}</code> variable placeholders</p>
</li>
<li>
<p>How to use multiline strings</p>
</li>
<li>
<p>How to use <code>log.info</code> to print information and save it in the log execution file</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_transcriptome_index_file">7.2. Create transcriptome index file</h3>
<div class="paragraph">
<p>Nextflow allows the execution of any command or user script by using a <code>process</code> definition.</p>
</div>
<div class="paragraph">
<p>A process is defined by providing three main declarations:
the process <a href="https://www.nextflow.io/docs/latest/process.html#inputs">inputs</a>,
the process <a href="https://www.nextflow.io/docs/latest/process.html#outputs">outputs</a>
and finally the command <a href="https://www.nextflow.io/docs/latest/process.html#script">script</a>.</p>
</div>
<div class="paragraph">
<p>The second example adds the <code>index</code> process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td>
  <td class="code"><pre>/*
 * pipeline input parameters
 */
params.reads = &quot;$baseDir/data/ggal/*_{1,2}.fq&quot;
params.transcriptome = &quot;$baseDir/data/ggal/transcriptome.fa&quot;
params.multiqc = &quot;$baseDir/multiqc&quot;
params.outdir = &quot;results&quot;

println &quot;&quot;&quot;\
         R N A S E Q - N F   P I P E L I N E
         ===================================
         transcriptome: ${params.transcriptome}
         reads        : ${params.reads}
         outdir       : ${params.outdir}
         &quot;&quot;&quot;
         .stripIndent()


/*
 * define the `index` process that create a binary index
 * given the transcriptome file
 */
process index {

    input:
    path transcriptome from params.transcriptome

    output:
    path 'index' into index_ch

    script:
    &quot;&quot;&quot;
    salmon index --threads $task.cpus -t $transcriptome -i index
    &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes the transcriptome params file as input and creates the transcriptome index by using the <code>salmon</code> tool.</p>
</div>
<div class="paragraph">
<p>Note how the input declaration defines a <code>transcriptome</code> variable in the process context
that it is used in the command script to reference that file in the Salmon command line.</p>
</div>
<div class="paragraph">
<p>Try to run it by using the command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script2.nf</pre>
</div>
</div>
<div class="paragraph">
<p>The execution will fail because Salmon is not installed in your environment.</p>
</div>
<div class="paragraph">
<p>Add the command line option <code>-with-docker</code> to launch the execution through a Docker container
as shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script2.nf -with-docker</pre>
</div>
</div>
<div class="paragraph">
<p>This time it works because it uses the Docker container <code>nextflow/rnaseq-nf</code> defined in the
<code>nextflow.config</code> file.</p>
</div>
<div class="paragraph">
<p>In order to avoid to add the option <code>-with-docker</code> add the following line in the <code>nextflow.config</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker.enabled = true</pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_15">7.2.1. Exercise</h4>
<div class="paragraph">
<p>Enable the Docker execution by default adding the above setting in the <code>nextflow.config</code> file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_16">7.2.2. Exercise</h4>
<div class="paragraph">
<p>Print the output of the <code>index_ch</code> channel by using the <a href="https://www.nextflow.io/docs/latest/operator.html#view">view</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_17">7.2.3. Exercise</h4>
<div class="paragraph">
<p>Use the command <code>tree work</code> to see how Nextflow organizes the process work directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_2">7.2.4. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to define a process executing a custom command</p>
</li>
<li>
<p>How process inputs are declared</p>
</li>
<li>
<p>How process outputs are declared</p>
</li>
<li>
<p>How to access the number of available CPUs</p>
</li>
<li>
<p>How to print the content of a channel</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_collect_read_files_by_pairs">7.3. Collect read files by pairs</h3>
<div class="paragraph">
<p>This step shows how to match <strong>read</strong> files into pairs, so they can be mapped by <strong>Salmon</strong>.</p>
</div>
<div class="paragraph">
<p>Edit the script <code>script3.nf</code> and add the following statement as the last line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>read_pairs_ch.view()</pre>
</div>
</div>
<div class="paragraph">
<p>Save it and execute it with the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script3.nf</pre>
</div>
</div>
<div class="paragraph">
<p>It will print an output similar to the one shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ggal_gut, [/.../data/ggal/gut_1.fq, /.../data/ggal/gut_2.fq]]</pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows how the <code>read_pairs_ch</code> channel emits tuples composed by
two elements, where the first is the read pair prefix and the second is a list
representing the actual files.</p>
</div>
<div class="paragraph">
<p>Try it again specifying different read files by using a glob pattern:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script3.nf --reads 'data/ggal/*_{1,2}.fq'</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
File paths including one or more wildcards ie. <code>*</code>, <code>?</code>, etc. MUST be
wrapped in single-quoted characters to avoid Bash expands the glob.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_exercise_18">7.3.1. Exercise</h4>
<div class="paragraph">
<p>Use the <a href="https://www.nextflow.io/docs/latest/operator.html#set">set</a> operator in place
of <code>=</code> assignment to define the <code>read_pairs_ch</code> channel.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_19">7.3.2. Exercise</h4>
<div class="paragraph">
<p>Use the <code>checkIfExists</code> option for the <a href="https://www.nextflow.io/docs/latest/channel.html#fromfilepairs">fromFilePairs</a> method to check if the specified path contains at least file pairs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_3">7.3.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to use <code>fromFilePairs</code> to handle read pair files</p>
</li>
<li>
<p>How to use the <code>checkIfExists</code> option to check input file existence</p>
</li>
<li>
<p>How to use the <code>set</code> operator to define a new channel variable</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_perform_expression_quantification">7.4. Perform expression quantification</h3>
<div class="paragraph">
<p>The script <code>script4.nf</code> adds the <code>quantification</code> process.</p>
</div>
<div class="paragraph">
<p>In this script note as the <code>index_ch</code> channel, declared as output in the <code>index</code> process,
is now used as a channel in the input section.</p>
</div>
<div class="paragraph">
<p>Also note as the second input is declared as a <code>tuple</code> composed by two elements:
the <code>pair_id</code> and the <code>reads</code> in order to match the structure of the items emitted
by the <code>read_pairs_ch</code> channel.</p>
</div>
<div class="paragraph">
<p>Execute it by using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script4.nf -resume</pre>
</div>
</div>
<div class="paragraph">
<p>You will see the execution of the <code>quantification</code> process.</p>
</div>
<div class="paragraph">
<p>The <code>-resume</code> option cause the execution of any step that has been already processed to be skipped.</p>
</div>
<div class="paragraph">
<p>Try to execute it with more read files as shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script4.nf -resume --reads 'data/ggal/*_{1,2}.fq'</pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that the <code>quantification</code> process is executed more than
one time.</p>
</div>
<div class="paragraph">
<p>Nextflow parallelizes the execution of your pipeline simply by providing multiple input data
to your script.</p>
</div>
<div class="sect3">
<h4 id="_exercise_20">7.4.1. Exercise</h4>
<div class="paragraph">
<p>Add a <a href="https://www.nextflow.io/docs/latest/process.html#tag">tag</a> directive to the
<code>quantification</code> process to provide a more readable execution log.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_21">7.4.2. Exercise</h4>
<div class="paragraph">
<p>Add a <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> directive
to the <code>quantification</code> process to store the process results into a directory of your choice.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recap_4">7.4.3. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to connect two processes by using the channel declarations</p>
</li>
<li>
<p>How to resume the script execution skipping already already computed steps</p>
</li>
<li>
<p>How to use the <code>tag</code> directive to provide a more readable execution output</p>
</li>
<li>
<p>How to use the <code>publishDir</code> to store a process results in a path of your choice</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quality_control">7.5. Quality control</h3>
<div class="paragraph">
<p>This step implements a quality control of your input reads. The inputs are the same
read pairs which are provided to the <code>quantification</code> steps</p>
</div>
<div class="paragraph">
<p>You can run it by using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script5.nf -resume</pre>
</div>
</div>
<div class="paragraph">
<p>The script will report the following error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Channel `read_pairs_ch` has been used twice as an input by process `fastqc` and process `quantification`</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_22">7.5.1. Exercise</h4>
<div class="paragraph">
<p>Modify the creation of the <code>read_pairs_ch</code> channel by using a <a href="https://www.nextflow.io/docs/latest/operator.html#into">into</a>
operator in place of a <code>set</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
see an example <a href="https://github.com/nextflow-io/rnaseq-nf/blob/3b5b49f/main.nf#L58">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap_5">7.5.2. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to use the <code>into</code> operator to create multiple copies of the same channel</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiqc_report">7.6. MultiQC report</h3>
<div class="paragraph">
<p>This step collect the outputs from the <code>quantification</code> and <code>fastqc</code> steps to create
a final report by using the <a href="http://multiqc.info/">MultiQC</a> tool.</p>
</div>
<div class="paragraph">
<p>Execute the script with the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script6.nf -resume --reads 'data/ggal/*_{1,2}.fq'</pre>
</div>
</div>
<div class="paragraph">
<p>It creates the final report in the <code>results</code> folder in the current work directory.</p>
</div>
<div class="paragraph">
<p>In this script note the use of the <a href="https://www.nextflow.io/docs/latest/operator.html#mix" target="_blank" rel="noopener">mix</a>
and <a href="https://www.nextflow.io/docs/latest/operator.html#collect" target="_blank" rel="noopener">collect</a> operators chained
together to get all the outputs of the <code>quantification</code> and <code>fastqc</code> process as a single
input.</p>
</div>
<div class="sect3">
<h4 id="_recap_6">7.6.1. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to collect many outputs to a single input with the <code>collect</code> operator</p>
</li>
<li>
<p>How to <code>mix</code> two channels in a single channel</p>
</li>
<li>
<p>How to chain two or more operators togethers</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handle_completion_event">7.7. Handle completion event</h3>
<div class="paragraph">
<p>This step shows how to execute an action when the pipeline completes the execution.</p>
</div>
<div class="paragraph">
<p>Note that Nextflow processes define the execution of <strong>asynchronous</strong> tasks i.e. they are not
executed one after another as they are written in the pipeline script as it would happen in a
common <strong>imperative</strong> programming language.</p>
</div>
<div class="paragraph">
<p>The script uses the <code>workflow.onComplete</code> event handler to print a confirmation message
when the script completes.</p>
</div>
<div class="paragraph">
<p>Try to run it by using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq'</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bonus">7.8. Bonus!</h3>
<div class="paragraph">
<p>Send a notification email when the workflow execution complete using the <code>-N &lt;email address&gt;</code>
command line option. Note: this requires the configuration of a SMTP server in nextflow config
file. For the sake of this tutorial add the following setting in your <code>nextflow.config</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>mail {
  from = 'info@nextflow.io'
  smtp.host = 'email-smtp.eu-west-1.amazonaws.com'
  smtp.port = 587
  smtp.user = &quot;xxxxx&quot;
  smtp.password = &quot;yyyyy&quot;
  smtp.auth = true
  smtp.starttls.enable = true
  smtp.starttls.required = true
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute again the previous example specifying your email address:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq' -c mail.config -N &lt;your email&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://www.nextflow.io/docs/latest/mail.html#mail-configuration" target="_blank" rel="noopener">mail documentation</a>
for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_scripts">7.9. Custom scripts</h3>
<div class="paragraph">
<p>Real world pipelines use a lot of custom user scripts (BASH, R, Python, etc). Nextflow
allows you to use and manage all these scripts in consistent manner. Simply put them
in a directory named <code>bin</code> in the pipeline project root. They will be automatically added
to the pipeline execution <code>PATH</code>.</p>
</div>
<div class="paragraph">
<p>For example, create a file named <code>fastqc.sh</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>#!/bin/bash
set -e
set -u

sample_id=${1}
reads=${2}

mkdir fastqc_${sample_id}_logs
fastqc -o fastqc_${sample_id}_logs -f fastq -q ${reads}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Save it, give execute permission and move it in the <code>bin</code> directory as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>chmod +x fastqc.sh
mkdir -p bin
mv fastqc.sh bin</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, open the <code>script7.nf</code> file and replace the <code>fastqc</code> process' script with
the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>  script:
  &quot;&quot;&quot;
  fastqc.sh &quot;$sample_id&quot; &quot;$reads&quot;
  &quot;&quot;&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it as before:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run script7.nf -resume --reads 'data/ggal/*_{1,2}.fq'</pre>
</div>
</div>
<div class="sect3">
<h4 id="_recap_7">7.9.1. Recap</h4>
<div class="paragraph">
<p>In this step you have learned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to write or use existing custom script in your Nextflow pipeline.</p>
</li>
<li>
<p>How to avoid the use of absolute paths having your scripts in the <code>bin/</code> project folder.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics_and_reports">7.10. Metrics and reports</h3>
<div class="paragraph">
<p>Nextflow is able to produce multiple reports and charts providing several runtime metrics
and execution information.</p>
</div>
<div class="paragraph">
<p>Run the <a href="https://github.com/nextflow-io/rnaseq-nf" target="_blank" rel="noopener">rnaseq-nf</a> pipeline
previously introduced as shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run rnaseq-nf -with-docker -with-report -with-trace -with-timeline -with-dag dag.png</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-with-report</code> option enables the creation of the workflow execution report. Open
the file <code>report.html</code> with a browser to see the report created with the above command.</p>
</div>
<div class="paragraph">
<p>The <code>-with-trace</code> option enables the create of a tab separated file containing runtime
information for each executed task. Check the content of the file <code>trace.txt</code> for an example.</p>
</div>
<div class="paragraph">
<p>The <code>-with-timeline</code> option enables the creation of the workflow timeline report showing
how processes where executed along time. This may be useful to identify most time consuming
tasks and bottlenecks. See an example at <a href="https://www.nextflow.io/docs/latest/tracing.html#timeline-report" target="_blank" rel="noopener">this link</a>.</p>
</div>
<div class="paragraph">
<p>Finally the <code>-with-dag</code> option enables to rendering of the workflow execution direct acyclic graph
representation. Note: this feature requires the installation of <a href="http://www.graphviz.org/" target="_blank" rel="noopener">Graphviz</a> in your computer.
See <a href="https://www.nextflow.io/docs/latest/tracing.html#dag-visualisation" target="_blank" rel="noopener">here</a> for details.</p>
</div>
<div class="paragraph">
<p>Note: runtime metrics may be incomplete for run short running tasks as in the case of this tutorial.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You view the HTML files right-clicking on the file name in the left side-bar and choosing the
<strong>Preview</strong> menu item.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_run_a_project_from_github">7.11. Run a project from GitHub</h3>
<div class="paragraph">
<p>Nextflow allows the execution of a pipeline project directly from a GitHub repository (or similar services eg. BitBucket and GitLab).</p>
</div>
<div class="paragraph">
<p>This simplifies the sharing and the deployment of complex projects and tracking changes in a consistent manner.</p>
</div>
<div class="paragraph">
<p>The following GitHub repository hosts a complete version of the workflow introduced in this tutorial:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/nextflow-io/rnaseq-nf" class="bare">github.com/nextflow-io/rnaseq-nf</a></p>
</div>
<div class="paragraph">
<p>You can run it by specifying the project name as shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run nextflow-io/rnaseq-nf -with-docker</pre>
</div>
</div>
<div class="paragraph">
<p>It automatically downloads it and store in the <code>$HOME/.nextflow</code> folder.</p>
</div>
<div class="paragraph">
<p>Use the command info to show the project information, e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow info nextflow-io/rnaseq-nf</pre>
</div>
</div>
<div class="paragraph">
<p>Nextflow allows the execution of a specific revision of your project by using the <code>-r</code> command line option. For Example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nextflow run nextflow-io/rnaseq-nf -r dev</pre>
</div>
</div>
<div class="paragraph">
<p>Revision are defined by using Git tags or branches defined in the project repository.</p>
</div>
<div class="paragraph">
<p>This allows a precise control of the changes in your project files and dependencies over time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources_3">7.12. More resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.nextflow.io" target="_blank" rel="noopener">Nextflow documentation</a> - The Nextflow docs home.</p>
</li>
<li>
<p><a href="https://github.com/nextflow-io/patterns" target="_blank" rel="noopener">Nextflow patterns</a> - A collection of Nextflow implementation patterns.</p>
</li>
<li>
<p><a href="https://github.com/CRG-CNAG/CalliNGS-NF" target="_blank" rel="noopener">CalliNGS-NF</a> - An Variant calling pipeline implementing GATK best practices.</p>
</li>
<li>
<p><a href="http://nf-co.re/" target="_blank" rel="noopener">nf-core</a> - A community collection of production ready genomic pipelines.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_manage_dependencies_containers">8. Manage dependencies &amp; containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Computational workflows rarely are composed by as single script or tool.
Most of the times they require the usage of dozens of different software
components or libraries.</p>
</div>
<div class="paragraph">
<p>Installing and maintaining such dependencies is a challenging task and
the most common source of irreproducibility in scientific applications.</p>
</div>
<div class="paragraph">
<p>Containers are exceptionally useful in scientific workflows. They allow the encapsulation of software dependencies, i.e. tools and libraries required by a data analysis application in  one or more self-contained, ready-to-run, immutable container images that can be easily deployed in any platform supporting the container runtime.</p>
</div>
<div class="sect2">
<h3 id="_docker_hands_on">8.1. Docker hands-on</h3>
<div class="paragraph">
<p>Get practice with basic Docker commands to pull, run and build your own containers.</p>
</div>
<div class="paragraph">
<p>A container is a ready-to-run Linux environment which can be executed in an isolated
manner from the hosting system. It has own copy of the file system, processes space,
memory management, etc.</p>
</div>
<div class="paragraph">
<p>Containers are a Linux feature known as <em>Control Groups</em> or <a href="https://en.wikipedia.org/wiki/Cgroups">Cgroups</a>
introduced with kernel 2.6.</p>
</div>
<div class="paragraph">
<p>Docker adds to this concept an handy management tool to build, run and share container images.</p>
</div>
<div class="paragraph">
<p>These images can be uploaded and published in a centralised repository know as
<a href="https://hub.docker.com">Docker Hub</a>, or hosted by other parties like for example <a href="https://quay.io">Quay</a>.</p>
</div>
<div class="sect3">
<h4 id="_run_a_container">8.1.1. Run a container</h4>
<div class="paragraph">
<p>Run a container is easy as using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run &lt;container-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run hello-world</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pull_a_container">8.1.2. Pull a container</h4>
<div class="paragraph">
<p>The pull command allows you to download a Docker image without running it. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull debian:stretch-slim</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command download a Debian Linux image.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_container_in_interactive_mode">8.1.3. Run a container in interactive mode</h4>
<div class="paragraph">
<p>Launching a BASH shell in the container allows you to operate in an interactive mode
in the containerised operating system. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run -it debian:stretch-slim bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once launched the container you wil noticed that&#8217;s running as root (!).
Use the usual commands to navigate in the file system.</p>
</div>
<div class="paragraph">
<p>To exit from the container, stop the BASH session with the exit command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_your_first_dockerfile">8.1.4. Your first Dockerfile</h4>
<div class="paragraph">
<p>Docker images are created by using a so called <code>Dockerfile</code> i.e. a simple text file
containing a list of commands to be executed to assemble and configure the image
with the software packages required.</p>
</div>
<div class="paragraph">
<p>In this step you will create a Docker image containing the Salmon tool.</p>
</div>
<div class="paragraph">
<p>Warning: the Docker build process automatically copies all files that are located in the
current directory to the Docker daemon in order to create the image. This can take
a lot of time when big/many files exist. For this reason it&#8217;s important to <em>always</em> work in
a directory containing only the files you really need to include in your Docker image.
Alternatively you can use the <code>.dockerignore</code> file to select the path to exclude from the build.</p>
</div>
<div class="paragraph">
<p>Then use your favourite editor eg. <code>vim</code> to create a file named <code>Dockerfile</code> and copy the
following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="docker"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>FROM debian:stretch-slim

MAINTAINER &lt;your name&gt;

RUN apt-get update &amp;&amp; apt-get install -y curl cowsay

ENV PATH=$PATH:/usr/games/</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>When done save the file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_build_the_image">8.1.5. Build the image</h4>
<div class="paragraph">
<p>Build the Docker image by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker build -t my-image .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: don&#8217;t miss the dot in the above command. When it completes, verify that the image
has been created listing all available images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker images</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can try your new container by running this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run my-image cowsay Hello Docker!</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_a_software_package_to_the_image">8.1.6. Add a software package to the image</h4>
<div class="paragraph">
<p>Add the Salmon package to the Docker image by adding to the <code>Dockerfile</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="docker"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>RUN curl -sSL https://github.com/COMBINE-lab/salmon/releases/download/v1.0.0/salmon-1.0.0_linux_x86_64.tar.gz | tar xz \
 &amp;&amp; mv /salmon-*/bin/* /usr/bin/ \
 &amp;&amp; mv /salmon-*/lib/* /usr/lib/</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and build again the image with the same command as before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker build -t my-image .</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that it creates a new Docker image with the same name <strong>but</strong> with a
different image ID.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_salmon_in_the_container">8.1.7. Run Salmon in the container</h4>
<div class="paragraph">
<p>Check that everything is fine running Salmon in the container as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run my-image salmon --version</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even launch a container in an interactive mode by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run -it my-image bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>exit</code> command to terminate the interactive session.</p>
</div>
</div>
<div class="sect3">
<h4 id="_file_system_mounts">8.1.8. File system mounts</h4>
<div class="paragraph">
<p>Create an genome index file by running Salmon in the container.</p>
</div>
<div class="paragraph">
<p>Try to run Salmon in the container with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run my-image \
  salmon index -t $PWD/data/ggal/transcriptome.fa -i transcript-index</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command fails because Salmon cannot access the input file.</p>
</div>
<div class="paragraph">
<p>This happens because the container runs in a complete separate file system and
it cannot access the hosting file system by default.</p>
</div>
<div class="paragraph">
<p>You will need to use the <code>--volume</code> command line option to mount the input file(s) eg.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run --volume $PWD/data/ggal/transcriptome.fa:/transcriptome.fa my-image \
  salmon index -t /transcriptome.fa -i transcript-index</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
the generated <code>transcript-index</code> directory is still not accessible in the host
file system (and actually it went lost).
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
An easier way is to mount a parent directory to an identical one in the container,
this allows you to use the same path when running it in the container eg.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run --volume $HOME:$HOME --workdir $PWD my-image \
  salmon index -t $PWD/data/ggal/transcriptome.fa -i transcript-index</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the content of the <code>transcript-index</code> folder entering the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ls -la transcript-index</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the permissions for files created by the Docker
execution is <code>root</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exercise_23">Exercise</h5>
<div class="paragraph">
<p>Use the option <code>-u $(id -u):$(id -g)</code> to allow Docker to create files with the right permission.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_upload_the_container_in_the_docker_hub_bonus">8.1.9. Upload the container in the Docker Hub (bonus)</h4>
<div class="paragraph">
<p>Publish your container in the Docker Hub to share it with other people.</p>
</div>
<div class="paragraph">
<p>Create an account in the <a href="https://hub.docker.com" class="bare">hub.docker.com</a> web site. Then from your shell terminal run
the following command, entering the user name and password you specified registering in the Hub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tag the image with your Docker user name account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker tag my-image &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally push it to the Docker Hub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker push &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that anyone will be able to download it by using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull &lt;user-name&gt;/my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how after a pull and push operation, Docker prints the container digest number e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Digest: sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266
Status: Downloaded newer image for nextflow/rnaseq-nf:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a unique and immutable identifier that can be used to reference container image
in a univocally manner. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker pull nextflow/rnaseq-nf@sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_nextflow_script_using_a_docker_container">8.1.10. Run a Nextflow script using a Docker container</h4>
<div class="paragraph">
<p>The simplest way to run a Nextflow script with a Docker image is using the
<code>-with-docker</code> command line option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run script2.nf -with-docker my-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll see later how to configure in the Nextflow config file which container
to use instead of having to specify every time as a command line argument.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_singularity">8.2. Singularity</h3>
<div class="paragraph">
<p><a href="http://singularity.lbl.gov">Singularity</a> is container runtime designed to work in HPC data center,
where the usage of Docker is generally not allowed due to security constraints.</p>
</div>
<div class="paragraph">
<p>Singularity implements a container execution model similarly to Docker however it uses
a complete different implementation design.</p>
</div>
<div class="paragraph">
<p>A Singularity container image is archived as a plain file that can be stored in a shared
file system and accessed by many computing nodes managed by a batch scheduler.</p>
</div>
<div class="sect3">
<h4 id="_create_a_singularity_images">8.2.1. Create a Singularity images</h4>
<div class="paragraph">
<p>Singularity images are created using a <code>Singularity</code> file in  similar manner to Docker,
though using a different syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="singularity"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre>Bootstrap: docker
From: debian:stretch-slim

%environment
export PATH=$PATH:/usr/games/

%labels
AUTHOR &lt;your name&gt;

%post

apt-get update &amp;&amp; apt-get install -y locales-all curl cowsay
curl -sSL https://github.com/COMBINE-lab/salmon/releases/download/v1.0.0/salmon-1.0.0_linux_x86_64.tar.gz | tar xz \
 &amp;&amp; mv /salmon-*/bin/* /usr/bin/ \
 &amp;&amp; mv /salmon-*/lib/* /usr/lib/</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have save the <code>Singularity</code> file. Create the image with these commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo singularity build my-image.sif Singularity</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: the <code>build</code> command requires sudo permissions. A common workaround
consists to build the image on a local workstation and then deploy in the
cluster just copying the image file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_a_container">8.2.2. Running a container</h4>
<div class="paragraph">
<p>Once done, you can run your container with the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity exec my-image.sif cowsay 'Hello Singularity'</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the <code>shell</code> command you can enter in the container in interactive mode.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity shell my-image.sif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once in the container instance run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">touch hello.txt
ls -la</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note how the files on the host environment are shown. Singularity automatically
mounts the host <code>$HOME</code> directory and uses the current work directory.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_import_a_docker_image">8.2.3. Import a Docker image</h4>
<div class="paragraph">
<p>An easier way to create Singularity container without requiring sudo permission and
boosting the containers interoperability is to import a Docker container image
pulling it directly from a Docker registry. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">singularity pull docker://debian:stretch-slim</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command automatically download the Debian Docker image and converts it to
a Singularity image store in the current directory with the name <code>debian-jessie.simg</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_nextflow_script_using_a_singularity_container">8.2.4. Run a Nextflow script using a Singularity container</h4>
<div class="paragraph">
<p>Nextflow allows the transparent usage of Singularity containers as easy as with
Docker ones.</p>
</div>
<div class="paragraph">
<p>It only requires to enable the use of Singularity engine in place of Docker in the
Nextflow configuration file using the <code>-with-singularity</code> command line option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script7.nf -with-singularity nextflow/rnaseq-nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before the Singularity container can also be provided in the Nextflow config file.
We&#8217;ll see later how to do it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_singularity_container_library">8.2.5. The Singularity Container Library</h4>
<div class="paragraph">
<p>The authors of Singularity, <a href="https://www.sylabs.io/">SyLabs</a> have their own repository of Singularity
containers.</p>
</div>
<div class="paragraph">
<p>In the same way that we can push docker images to Docker Hub, we can upload Singularity images
to the Singularity Library.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_condabioconda_packages">8.3. Conda/Bioconda packages</h3>
<div class="paragraph">
<p>Conda is popular package and environment manager. The built-in support for Conda
allows Nextflow pipelines to automatically creates and activates the Conda
environment(s) given the dependencies specified by each process.</p>
</div>
<div class="paragraph">
<p>A Conda environment is defined using a YAML file which lists the required software packages.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">name</span>: <span class="string"><span class="content">nf-tutorial</span></span>
<span class="key">channels</span>:
  - <span class="string"><span class="content">defaults</span></span>
  - <span class="string"><span class="content">bioconda</span></span>
  - <span class="string"><span class="content">conda-forge</span></span>
<span class="key">dependencies</span>:
  - <span class="string"><span class="content">salmon=1.0.0</span></span>
  - <span class="string"><span class="content">fastqc=0.11.5</span></span>
  - <span class="string"><span class="content">multiqc=1.5</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the recipe file, the environment is created using the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda env create --file env.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the environment was created successfully with the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda env list</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable the environment you can use the <code>activate</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conda activate nf-tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nextflow is able to manage the activation of a Conda environment when the its directory
is specified using the <code>-with-conda</code> option. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script7.nf -with-conda /home/ubuntu/miniconda2/envs/nf-tutorial</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When specifying as Conda environment a YAML recipe file, Nextflow automatically downloads the required dependencies, build the environment and automatically activate it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This makes easier to manage different environments for the processes in the workflow script.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://www.nextflow.io/docs/latest/conda.html">Nextflow</a>
in the Nextflow documentation for details.</p>
</div>
<div class="sect3">
<h4 id="_bonus_exercise">8.3.1. Bonus Exercise</h4>
<div class="paragraph">
<p>Take a look at the Dockerfile of the <a href="https://github.com/nextflow-io/rnaseq-nf">rnaseq-nf</a> pipeline to determine how it is built.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_biocontainers">8.4. BioContainers</h3>
<div class="paragraph">
<p>Another useful resource linking together Bioconda and containers is the <a href="https://biocontainers.pro">BioContainers</a> project.
BioContainers is a community initiative that provides a registry of container images for every Bioconda recipe.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_resources_4">8.5. More resources</h3>
<div class="paragraph">
<p><a href="https://github.com/brouberol/marcel">Marcel</a> the french Docker .. (humor)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nextflow_configuration">9. Nextflow configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A key Nextflow feature is the ability to decouple the workflow implementation
by the configuration setting required by the underlying execution platform.</p>
</div>
<div class="paragraph">
<p>This enable portable deployment without the need to modify the application code.</p>
</div>
<div class="sect2">
<h3 id="_configuration_file">9.1. Configuration file</h3>
<div class="paragraph">
<p>When a pipeline script is launched Nextflow looks for a file named <code>nextflow.config</code> in the current directory and in the script base directory (if it is not the same as the current directory). Finally it checks for the file <code>$HOME/.nextflow/config</code>.</p>
</div>
<div class="paragraph">
<p>When more than one on the above files exist they are merged, so that the settings in the first override the same ones that may appear in the second one, and so on.</p>
</div>
<div class="paragraph">
<p>The default config file search mechanism can be extended proving an extra configuration file by using the command line option <code>-c &lt;config file&gt;</code>.</p>
</div>
<div class="sect3">
<h4 id="_config_syntax">9.1.1. Config syntax</h4>
<div class="paragraph">
<p>A Nextflow configuration file is a simple text file containing a set of properties defined using the syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>name = value</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please note, string values need to be wrapped in quotation characters while numbers and boolean values (<code>true</code>, <code>false</code>) do not. Also note that values are typed, meaning for example that, <code>1</code> is different from <code>'1'</code>, since the first is interpreted as the number one, while the latter is interpreted as a string value.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_config_variables">9.1.2. Config variables</h4>
<div class="paragraph">
<p>Configuration properties can be used as variables in the configuration file itself, by using the usual <code>$propertyName</code> or <code>${expression}</code> syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>propertyOne = 'world'
anotherProp = &quot;Hello $propertyOne&quot;
customPath = &quot;$PATH:/my/app/folder&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the configuration file it&#8217;s possible to access any variable defined in the host environment
such as <code>$PATH</code>, <code>$HOME</code>, <code>$PWD</code>, etc.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_config_comments">9.1.3. Config comments</h4>
<div class="paragraph">
<p>Configuration files use the same conventions for comments used in the Nextflow script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>// comment a single config file

/*
   a comment spanning
   multiple lines
 */</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_scopes">9.1.4. Config scopes</h4>
<div class="paragraph">
<p>Configuration settings can be organized in different scopes by dot prefixing the property names with a scope
identifier or grouping the properties in the same scope using the curly brackets notation. This is shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>alpha.x  = 1
alpha.y  = 'string value..'

beta {
    p = 2
    q = 'another string ..'
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_params">9.1.5. Config params</h4>
<div class="paragraph">
<p>The scope <code>params</code> allows the definition of workflow parameters that overrides the values defined
in the main workflow script.</p>
</div>
<div class="paragraph">
<p>This is useful to consolidate one or more execution parameters in a separate file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>// config file
params.foo = 'Bonjour'
params.bar = 'le monde!'</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>// workflow script
params.foo = 'Hello'
params.bar = 'world!'

// print the both params
println &quot;$params.foo $params.bar&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_24">Exercise</h5>
<div class="paragraph">
<p>Save the first snippet as <code>nextflow.config</code> and the second one as <code>params.nf</code>. Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run params.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute is again specifying the <code>foo</code> parameter on the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run params.nf --foo Hola</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare the result of the two executions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_env">9.1.6. Config env</h4>
<div class="paragraph">
<p>The <code>env</code> scope allows the definition one or more variable that will be exported in the environment where the workflow tasks will be executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>env.ALPHA = 'some value'
env.BETA = &quot;$HOME/some/path&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_exercise_25">Exercise</h5>
<div class="paragraph">
<p>Save the above snippet a file named <code>my-env.config</code>. The save the snippet below in a file named
<code>foo.nf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>process foo {
  echo true
  '''
  env | egrep 'ALPHA|BETA'
  '''
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally executed the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run foo.nf -c my-env.config</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_process">9.1.7. Config process</h4>
<div class="paragraph">
<p>The process <a href="https://www.nextflow.io/docs/latest/process.html#directives">directives</a> allow the specification of specific settings for the task execution such as <code>cpus</code>, <code>memory</code>, <code>container</code> and other resources in the pipeline script.</p>
</div>
<div class="paragraph">
<p>This is useful specially when prototyping a small workflow script.</p>
</div>
<div class="paragraph">
<p>However it&#8217;s always a good practice to decouple the workflow execution
logic from the process configuration settings, i.e. it&#8217;s strongly
suggested to define the process settings in the workflow configuration
file instead of the workflow script.</p>
</div>
<div class="paragraph">
<p>The <code>process</code> configuration scope allows the setting of any process <a href="https://www.nextflow.io/docs/latest/process.html#directives">directives</a> in the Nextflow configuration file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>process {
    cpus = 10
    memory = 8.GB
    container = 'biocontainers/bamtools:v2.4.0_cv3'
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above config snippet defines the <code>cpus</code>, <code>memory</code> and <code>container</code>
directives for all processes in your workflow script.</p>
</div>
<div class="paragraph">
<p>The <a href="https://www.nextflow.io/docs/latest/config.html#process-selectors">process selector</a> can be used to apply the configuration to a specific
process or group of processes (discussed later).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Memory and time duration unit can be specified either
using a string based notation in which the digit(s) and the unit
<strong>can</strong> be separated by a blank or by using the numeric notation in
which the digit(s) and the unit are separated by a dot character and
it&#8217;s not enclosed by quote characters.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">String syntax</th>
<th class="tableblock halign-left valign-top">Numeric syntax</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'10 KB'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.KB</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10240 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'500 MB'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>500.MB</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">524288000 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'1 min'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'1 hour 25 sec'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 hour and 25 seconds</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The syntax for setting process directives in the
configuration file requires <code>=</code> ie. assignment operator, instead
it should not be used when setting process directives in the
workflow script.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This important especially when you want to define a config setting
using a dynamic expression using a closure. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process {
    memory = { 4.GB * task.cpus }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Directives that requires more than one value, e.g. <a href="https://www.nextflow.io/docs/latest/process.html#pod">pod</a>, in the
configuration file need to be expressed as a map object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process {
    pod = [env: 'FOO', value: '123']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally directives that allows to be repeated in the process
definition, in the configuration files need to be defined
as a list object. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process {
    pod = [ [env: 'FOO', value: '123'],
            [env: 'BAR', value: '456'] ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_docker_execution">9.1.8. Config Docker execution</h4>
<div class="paragraph">
<p>The container image to be used for the process execution can be specified in the <code>nextflow.config</code>
file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>process.container = 'nextflow/rnaseq-nf'
docker.enabled = true</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The use of the unique SHA256 image ID guarantees that the image content do not change
over time
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>process.container = 'nextflow/rnaseq-nf@sha256:aeacbd7ea1154f263cda972a96920fb228b2033544c2641476350b9317dab266'
docker.enabled = true</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_config_singularity_execution">9.1.9. Config Singularity execution</h4>
<div class="paragraph">
<p>The run the workflow execution with a Singularity container provide the container
image file path in the Nextflow config file using the container directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>process.container = '/some/singularity/image.sif'
singularity.enabled = true</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The container image file must be an absolute path i.e. it must start with a <code>/</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following protocols are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>library://</code> download the container image from the <a href="https://cloud.sylabs.io/library">Singularity Library service</a>.</p>
</li>
<li>
<p><code>shub://</code> download the container image from the <a href="https://singularity-hub.org/">Singularity Hub</a>.</p>
</li>
<li>
<p><code>docker://</code> download the container image from the <a href="https://hub.docker.com/">Docker Hub</a> and convert it to
the Singularity format.</p>
</li>
<li>
<p><code>docker-daemon://</code> pull the container image from a local Docker installation and convert it to a Singularity image file.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Specifying a plain Docker container image name, Nextflow implicitly download and converts it to
a Singularity image when the Singularity execution is enabled. For example:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>process.container = 'nextflow/rnaseq-nf'
singularity.enabled = true</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration instructs Nextflow to use Singularity engine to run
your script processes. The container is pulled from the Docker registry and cached
in the current directory to be used for further runs.</p>
</div>
<div class="paragraph">
<p>Alternatively if you have a Singularity image file, its location absolute path
can be specified as the container name either using the <code>-with-singularity</code> option
or the <code>process.container</code> setting in the config file.</p>
</div>
<div class="paragraph">
<p>Try to run the script as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">nextflow run script7.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: Nextflow will pull the container image automatically, it will require a few seconds
depending the network connection speed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_config_conda_execution">9.1.10. Config Conda execution</h4>
<div class="paragraph">
<p>The use of a Conda environment can also be provided in the configuration file
adding the following setting in the <code>nextflow.config</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>process.conda = &quot;/home/ubuntu/miniconda2/envs/nf-tutorial&quot;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can either specify the path of an existing Conda environment <strong>directory</strong> or the
path of Conda environment YAML file.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployments_scenarios">10. Deployments scenarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Real world genomic application can spawn the execution of thousands of jobs. In this
scenario a batch scheduler is commonly used to deploy a pipeline in a computing cluster,
allowing the execution of many jobs in parallel across many computing nodes.</p>
</div>
<div class="paragraph">
<p>Nextflow has built-in support for most common used batch schedulers such as Univa Grid Engine
and <a href="https://slurm.schedmd.com/">SLURM</a> and IBM LSF between the other. Check the Nextflow documentation for
the complete list of supported <a href="https://www.nextflow.io/docs/latest/executor.html">execution platforms</a>.</p>
</div>
<div class="sect2">
<h3 id="_cluster_deployment">10.1. Cluster deployment</h3>
<div class="paragraph">
<p>A key Nextflow feature is the ability to decouple the workflow implementation from the
actual execution platform implementing an abstraction layer that allows the deployment
of the resulting workflow on any executing platform support by the framework.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/nf-executors.png" alt="nf executors"></span></p>
</div>
<div class="paragraph">
<p>To run your pipeline with a batch scheduler modify the <code>nextflow.config</code> file specifying
the target executor and the required computing resources if needed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>process.executor = 'slurm'</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_managing_cluster_resources">10.2. Managing cluster resources</h3>
<div class="paragraph">
<p>When using a batch scheduler is generally needed to specify the amount of resources
i.e. cpus, memory, execution time, etc. required by each task.</p>
</div>
<div class="paragraph">
<p>This can be done using the following process directives:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#queue">queue</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the cluster <em>queue</em> to be used for the computation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#cpus">cpus</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the number of <em>cpus</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#memory">memory</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the amount of <em>memory</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#time">time</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the max amount of <em>time</em> to be allocated a task execution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nextflow.io/docs/latest/process.html#disk">disk</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the amount of disk storage required a task execution</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_workflow_wide_resources">10.2.1. Workflow wide resources</h4>
<div class="paragraph">
<p>Use the scope <code>process</code> to define the resource requirements for all processes in
your workflow applications. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>process {
    executor = 'slurm'
    queue = 'short'
    memory = '10 GB'
    time = '30 min'
    cpus = 4
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_process_by_name">10.2.2. Configure process by name</h4>
<div class="paragraph">
<p>In real world application different tasks need different amount of
computing resources. It is possible to define the resources for a specific task
using the select <code>withName:</code> followed by the process name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre>process {
    executor = 'slurm'
    queue = 'short'
    memory = '10 GB'
    time = '30 min'
    cpus = 4

    withName: foo {
        cpus = 4
        memory = '20 GB'
        queue = 'short'
    }

    withName: bar {
        cpus = 8
        memory = '32 GB'
        queue = 'long'
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_process_by_labels">10.2.3. Configure process by labels</h4>
<div class="paragraph">
<p>When a workflow application is composed by many processes can be overkill listing all process names
in the configuration file to specifies the resources for each of them.</p>
</div>
<div class="paragraph">
<p>A better strategy consist to annotate the processes with a <a href="https://www.nextflow.io/docs/latest/process.html#label">label</a> directive. Then specify
the resources in the configuration file using for all processes having the same label.</p>
</div>
<div class="paragraph">
<p>The workflow script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre>
process task1 {
  label 'long'

  &quot;&quot;&quot;
  first_command --here
  &quot;&quot;&quot;
}

process task2 {
  label 'short'

  &quot;&quot;&quot;
  second_command --here
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre>process {
    executor = 'slurm'

    withLabel: 'short' {
        cpus = 4
        memory = '20 GB'
        queue = 'alpha'
    }

    withLabel: 'long' {
        cpus = 8
        memory = '32 GB'
        queue = 'omega'
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_multiple_containers">10.2.4. Configure multiple containers</h4>
<div class="paragraph">
<p>It is possible to use a different container for each process in your workflow. For having
a workflow script defining two process, it&#8217;s possible to define a config file as shown
below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre>process {
  withName: foo {
    container = 'some/image:x'
  }
  withName: bar {
    container = 'other/image:y'
  }
}

docker.enabled = true</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A single <em>fat</em> container or many <em>slim</em> containers? Both approaches have pros &amp; cons.
A single container is simpler to build and to maintain, however when using many tools
the image can become very big and tools can conflict each other. Using a container for each
process can result in many different images to build and to maintain, especially when
processes in your workflow uses different tools in each task.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read more about config process selector at <a href="https://www.nextflow.io/docs/latest/config.html#process-selectors">this link</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_profiles">10.3. Configuration profiles</h3>
<div class="paragraph">
<p>Configuration files can contain the definition of one or more <em>profiles</em>. A profile is a set of configuration attributes that can be activated/chosen when launching a pipeline execution by using the <code>-profile</code> command line option.</p>
</div>
<div class="paragraph">
<p>Configuration profiles are defined by using the special scope <code>profiles</code> which group the attributes that belong to the same profile using a common prefix. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre>profiles {

    standard {
        params.genome = '/local/path/ref.fasta'
        process.executor = 'local'
    }

    cluster {
        params.genome = '/data/stared/ref.fasta'
        process.executor = 'sge'
        process.queue = 'long'
        process.memory = '10GB'
        process.conda = '/some/path/env.yml'
    }

    cloud {
        params.genome = '/data/stared/ref.fasta'
        process.executor = 'awsbatch'
        process.container = 'cbcrg/imagex'
        docker.enabled = true
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration defines three different profiles: <code>standard</code>, <code>cluster</code> and <code>cloud</code> that set different process configuration strategies depending on the target runtime platform. By convention the <code>standard</code> profile is implicitly used when no other profile is specified by the user.</p>
</div>
<div class="paragraph">
<p>To enable a specific profile use <code>-profile</code> option followed by the profile name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run &lt;your script&gt; -profile cluster</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two or more configuration profiles can be specified by separating the profile names with a comma character:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cmd">nextflow run &lt;your script&gt; -profile standard,cloud</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cloud_deployment">10.4. Cloud deployment</h3>
<div class="paragraph">
<p><a href="https://aws.amazon.com/batch/">AWS Batch</a> is a managed computing service that allows the execution of containerised workloads in the Amazon cloud infrastructure.</p>
</div>
<div class="paragraph">
<p>Nextflow provides a built-in support for AWS Batch which allows the seamless deployment of a Nextflow pipeline in the cloud offloading the process executions as Batch jobs.</p>
</div>
<div class="paragraph">
<p>Once the Batch environment is configured specifying the instance types to be used and the max number
of cpus to be allocated, you need to created a Nextflow configuration file like the one showed below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>process.executor = 'awsbatch'       <i class="conum" data-value="1"></i><b>(1)</b>
process.queue = 'nextflow-ci'       <i class="conum" data-value="2"></i><b>(2)</b>
process.container = 'nextflow/rnaseq-nf:latest'      <i class="conum" data-value="3"></i><b>(3)</b>
workDir = 's3://nextflow-ci/work/'  <i class="conum" data-value="4"></i><b>(4)</b>
aws.region = 'eu-west-1'            <i class="conum" data-value="5"></i><b>(5)</b>
aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws' <i class="conum" data-value="6"></i><b>(6)</b>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the AWS Batch as the executor to run the processes in the workflow</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the computing queue defined in the Batch environment</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The Docker container image to be used to run each job</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The workflow work directory must be a AWS S3 bucket</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The AWS region to be used</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The path of the AWS cli tool required to download/upload files to/from the container</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The best practices is to keep this setting as a separate profile in your
workflow config file. This allows the execution with a simple command.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run script7.nf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete details about AWS Batch deployment are available at <a href="https://www.nextflow.io/docs/latest/awscloud.html#aws-batch">this link</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_volume_mounts">10.5. Volume mounts</h3>
<div class="paragraph">
<p>EBS volumes (or other supported storage) can be mounted in the job container using the following configuration snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>aws {
  batch {
      volumes = '/some/path'
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple volumes can be specified using comma-separated paths. The usual Docker volume mount syntax can be used to define complex volumes for which the container paths is different from the host paths or to specify a read-only option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>aws {
  region = 'eu-west-1'
  batch {
      volumes = ['/tmp', '/host/path:/mnt/path:ro']
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>IMPORTANT:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This a global configuration that has to be specified in a Nextflow config file, as such it&#8217;s applied to <strong>all</strong> process executions.</p>
</li>
<li>
<p>Nextflow expects those paths to be available. It does not handle the provision of EBS volumes or
other kind of storage.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_job_definition">10.6. Custom job definition</h3>
<div class="paragraph">
<p>Nextflow automatically creates the Batch <a href="https://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html">Job definitions</a> needed to execute your pipeline processes. Therefore it&#8217;s not required to define them before run your workflow.</p>
</div>
<div class="paragraph">
<p>However, you may still need to specify a custom Job Definition to provide fine-grained control of the configuration settings of a specific job e.g. to define custom mount paths or other special settings of a Batch Job.</p>
</div>
<div class="paragraph">
<p>To use your own job definition in a Nextflow workflow, use it in place of the container image name,
prefixing it with the <code>job-definition://</code> string. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>process {
    container = 'job-definition://your-job-definition-name'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_custom_image">10.7. Custom image</h3>
<div class="paragraph">
<p>Since Nextflow requires the AWS CLI tool to be accessible in the computing environment
a common solution consists of creating a custom AMI and install it in a self-contained manner
e.g. using Conda package manager.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When creating your custom AMI for AWS Batch, make sure to use the <em>Amazon ECS-Optimized Amazon Linux AMI</em> as the base image.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following snippet shows how to install AWS CLI with Miniconda:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo yum install -y bzip2 wget
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $HOME/miniconda
$HOME/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>aws</code> tool will be placed in a directory named <code>bin</code> in the main installation folder. Modifying this directory structure, after the installation, this will cause the tool not to work properly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally specify the <code>aws</code> full path in the Nextflow config file as show below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_launch_template">10.8. Launch template</h3>
<div class="paragraph">
<p>An alternative to is to create a custom AMI using a
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html">Launch template</a> that
installs the AWS CLI tool during the instance boot via a custom user-data.</p>
</div>
<div class="paragraph">
<p>In the EC2 dashboard create a Launch template specifying in the user data field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&quot;//&quot;

--//
Content-Type: text/x-shellscript; charset=&quot;us-ascii&quot;

#!/bin/sh
## install required deps
set -x
export PATH=/usr/local/bin:$PATH
yum install -y jq python27-pip sed wget bzip2
pip install -U boto3

## install awscli
USER=/home/ec2-user
wget -q https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $USER/miniconda
$USER/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh
chown -R ec2-user:ec2-user $USER/miniconda

--//--</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in the Batch dashboard create a new compute environment and specify the newly created
launch template in the corresponding field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hybrid_deployments">10.9. Hybrid deployments</h3>
<div class="paragraph">
<p>Nextflow allows the use of multiple executors in the same workflow application. This feature enables the deployment of hybrid workloads in which some jobs are execute in the local computer or local computing cluster and some jobs are offloaded to AWS Batch service.</p>
</div>
<div class="paragraph">
<p>To enable this feature use one or more <a href="https://www.nextflow.io/docs/latest/config.html#config-process-selectors">process selectors</a> in your Nextflow configuration file to apply the <a href="https://www.nextflow.io/docs/latest/awscloud.html#awscloud-batch-config">AWS Batch configuration</a> only to a subset of processes in your workflow. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>process {
    executor = 'slurm'  <i class="conum" data-value="1"></i><b>(1)</b>
    queue = 'short'     <i class="conum" data-value="2"></i><b>(2)</b>

    withLabel: bigTask {          <i class="conum" data-value="3"></i><b>(3)</b>
      executor = 'awsbatch'       <i class="conum" data-value="4"></i><b>(4)</b>
      queue = 'my-batch-queue'    <i class="conum" data-value="5"></i><b>(5)</b>
      container = 'my/image:tag'  <i class="conum" data-value="6"></i><b>(6)</b>
  }
}

aws {
    region = 'eu-west-1'    <i class="conum" data-value="7"></i><b>(7)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>slurm</code> as the default executor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the queue for the SLURM cluster</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting of for the process named <code>bigTask</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set <code>awsbatch</code> as executor for the <code>bigTask</code> process</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the queue for the for the <code>bigTask</code> process</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>set the container image to deploy the <code>bigTask</code> process</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Defines the region for Batch execution</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_execution_cache_and_resume">11. Execution cache and resume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nextflow caching mechanism works assigning a unique ID to each task
which is used to create a separate execution directory where the tasks
are executed and the results stored.</p>
</div>
<div class="paragraph">
<p>The task unique ID is generated as a 128-bit hash number obtained
composing the task inputs values and files and the command string.</p>
</div>
<div class="paragraph">
<p>The pipeline work directory is organized as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>work/
 12
  1adacb582d2198cd32db0e6f808bce
      genome.fa -&gt; /data/../genome.fa
      index
          hash.bin
          header.json
          indexing.log
          quasi_index.log
          refInfo.json
          rsd.bin
          sa.bin
          txpInfo.bin
          versionInfo.json
 19
  663679d1d87bfeafacf30c1deaf81b
      ggal_gut
       aux_info
        ambig_info.tsv
        expected_bias.gz
        fld.gz
        meta_info.json
        observed_bias.gz
        observed_bias_3p.gz
       cmd_info.json
       libParams
        flenDist.txt
       lib_format_counts.json
       logs
        salmon_quant.log
       quant.sf
      ggal_gut_1.fq -&gt; /data/../ggal_gut_1.fq
      ggal_gut_2.fq -&gt; /data/../ggal_gut_2.fq
      index -&gt; /data/../asciidocs/day2/work/12/1adacb582d2198cd32db0e6f808bce/index</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_how_resume_works">11.1. How resume works</h3>
<div class="paragraph">
<p>The <code>-resume</code> command line option allow the continuation of a pipeline
execution since the last step that was successfully completed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run &lt;script&gt; -resume</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practical terms the pipeline is executed from the beginning
however before launching the execution of a process. Nextflow
uses the task unique ID to check if the work directory already
exists and it contains a valid command exit status and the
expected output files.</p>
</div>
<div class="paragraph">
<p>If this condition is satisfied the task execution is skipped and previously computed results are used as the process results.</p>
</div>
<div class="paragraph">
<p>The first task, for which a new output is computed, invalidates all
downstream executions in the remaining DAG.</p>
</div>
</div>
<div class="sect2">
<h3 id="_work_directory">11.2. Work directory</h3>
<div class="paragraph">
<p>The task work directories are created in the folder <code>work</code> in
the launching path by default. This is supposed to be a <strong>scratch</strong>
storage area that can be cleaned up once the computation is completed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Workflow final output are supposed to the stored in a different
location specified using one or more <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir</a> directive.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A different location for the execution work directory can be specified
using the command line option <code>-w</code> e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run &lt;script&gt; -w /some/scratch/dir</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you delete or more the pipeline work directory will
prevent to use the resume feature in following runs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The hash code for input files is computed using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The complete file path</p>
</li>
<li>
<p>The file size</p>
</li>
<li>
<p>The last modified timestamp</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore just <strong>touching</strong> a file will invalidated the related
task execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_organize_in_silico_experiments">11.3. How organize in silico experiments</h3>
<div class="paragraph">
<p>It&#8217;s a good practice to organize each each <strong>experiment</strong>
in its own folder. The experiment main input parameters should be specified using a Nextflow config file. This makes simply to track
and replicate the experiment over time.</p>
</div>
<div class="paragraph">
<p>Note that in the same experiment the same pipeline can be executed multiple times,
however it should be avoided to launch two (or more) Nextflow instances in the same
directory concurrently.</p>
</div>
<div class="paragraph">
<p>The <code>nextflow log</code> command lists the executions run in the current folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>$ nextflow log

TIMESTAMP            DURATION  RUN NAME          STATUS  REVISION ID  SESSION ID                            COMMAND
2019-05-06 12:07:32  1.2s      focused_carson    ERR     a9012339ce   7363b3f0-09ac-495b-a947-28cf430d0b85  nextflow run hello
2019-05-06 12:08:33  21.1s     mighty_boyd       OK      a9012339ce   7363b3f0-09ac-495b-a947-28cf430d0b85  nextflow run rnaseq-nf -with-docker
2019-05-06 12:31:15  1.2s      insane_celsius    ERR     b9aefc67b4   4dc656d2-c410-44c8-bc32-7dd0ea87bebf  nextflow run rnaseq-nf
2019-05-06 12:31:24  17s       stupefied_euclid  OK      b9aefc67b4   4dc656d2-c410-44c8-bc32-7dd0ea87bebf  nextflow run rnaseq-nf -resume -with-docker</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use either the <strong>session ID</strong> or the <strong>run name</strong> to recover a specific execution. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow run rnaseq-nf -resume mighty_boyd</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_execution_provenance">11.4. Execution provenance</h3>
<div class="paragraph">
<p>The <code>log</code> command when provided with a <strong>run name</strong> or <strong>session ID</strong> can return many useful information about a pipeline execution that can be used to create a provenance report.</p>
</div>
<div class="paragraph">
<p>By default, it lists the work directories used to compute each task.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log tiny_fermat

/data/.../work/7b/3753ff13b1fa5348d2d9b6f512153a
/data/.../work/c1/56a36d8f498c99ac6cba31e85b3e0c
/data/.../work/f7/659c65ef60582d9713252bcfbcc310
/data/.../work/82/ba67e3175bd9e6479d4310e5a92f99
/data/.../work/e5/2816b9d4e7b402bfdd6597c2c2403d
/data/.../work/3b/3485d00b0115f89e4c202eacf82eba</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the option <code>-f</code> (fields) it&#8217;s possible to specify which metadata
should be printed by the <code>log</code> command. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log tiny_fermat -f 'process,exit,hash,duration'

index    0   7b/3753ff  2.0s
fastqc   0   c1/56a36d  9.3s
fastqc   0   f7/659c65  9.1s
quant    0   82/ba67e3  2.7s
quant    0   e5/2816b9  3.2s
multiqc  0   3b/3485d0  6.3s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete list of available fields can be retrieved with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow log -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option <code>-F</code> allows the specification of a filtering criteria to
print only a subset of tasks. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ nextflow log tiny_fermat -F 'process =~ /fastqc/'

/data/.../work/c1/56a36d8f498c99ac6cba31e85b3e0c
/data/.../work/f7/659c65ef60582d9713252bcfbcc310</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful to locate specific tasks work directories.</p>
</div>
<div class="paragraph">
<p>Finally, the <code>-t</code> option allow the creation of a basic custom provenance report proving a template file, in any format of your choice. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div&gt;</span>
<span class="tag">&lt;h2&gt;</span>${name}<span class="tag">&lt;/h2&gt;</span>
<span class="tag">&lt;div&gt;</span>
Script:
<span class="tag">&lt;pre&gt;</span>${script}<span class="tag">&lt;/pre&gt;</span>
<span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;ul&gt;</span>
    <span class="tag">&lt;li&gt;</span>Exit: ${exit}<span class="tag">&lt;/li&gt;</span>
    <span class="tag">&lt;li&gt;</span>Status: ${status}<span class="tag">&lt;/li&gt;</span>
    <span class="tag">&lt;li&gt;</span>Work dir: ${workdir}<span class="tag">&lt;/li&gt;</span>
    <span class="tag">&lt;li&gt;</span>Container: ${container}<span class="tag">&lt;/li&gt;</span>
<span class="tag">&lt;/ul&gt;</span>
<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the above snippet in a file named <code>template.html</code>. Then
run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>nextflow log tiny_fermat -t template.html &gt; prov.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally open the file <code>prov.html</code> file with a browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resume_troubleshooting">11.5. Resume troubleshooting</h3>
<div class="paragraph">
<p>If your workflow execution is not resumed as expected and
one or more task are re-executed all the times, these may
be the most likely causes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Input file changed</strong>: Make sure that there&#8217;s no change
in your input files. Don&#8217;t forget task unique hash is computed
taking into account the complete file path, the last modified
timestamp and the file size. If any of these information changes,
the workflow will be re-executed even if the input content is the same.</p>
</li>
<li>
<p><strong>A process modifies an input</strong>: A process should never alter input
files otherwise the resume, for future executions, will be invalidated
for the same reason explained in the previous point.</p>
</li>
<li>
<p><strong>Inconsistent file attributes</strong>: Some shared file system,
such as <a href="https://en.wikipedia.org/wiki/Network_File_System">NFS</a>, may report
inconsistent file timestamp i.e. a different timestamp for the same
file even if it has not be modified. To prevent this problem use
the <a href="https://www.nextflow.io/docs/latest/process.html#cache">lenient cache strategy</a>.</p>
</li>
<li>
<p><strong>Race condition in global variable</strong>: Nextflow is designed to simplify parallel programming without taking care about race conditions and the access to shared resources. One of the few cases in which a race condition can arise is when using a global variable
with two (or more) operators. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>Channel
    .from(1,2,3)
    .map { it -&gt; X=it; X+=2 }
    .view { &quot;ch1 = $it&quot; }

Channel
    .from(1,2,3)
    .map { it -&gt; X=it; X*=2 }
    .view { &quot;ch2 = $it&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem in this snippet is that the <code>X</code> variable in the closure
definition is defined in the global scope. Therefore, since operators are
executed in parallel, the <code>X</code> value can be overwritten
by the other <code>map</code> invocation.</p>
</div>
<div class="paragraph">
<p>The correct implementation requires the use of the <code>def</code> keyword to declare
the variable <strong>local</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>Channel
    .from(1,2,3)
    .map { it -&gt; def X=it; X+=2 }
    .println { &quot;ch1 = $it&quot; }

Channel
    .from(1,2,3)
    .map { it -&gt; def X=it; X*=2 }
    .println { &quot;ch2 = $it&quot; }</pre></td>
</tr></table></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Not deterministic input channels</strong>: While dataflow channel ordering is
guaranteed i.e. data is read in the same order in which it&#8217;s written in
the channel, when a process declares as input two or more
channel each of which is the output of a <strong>different</strong> process the
overall input ordering is not consistent over different executions.</p>
<div class="paragraph">
<p>In practical term, consider the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre>process foo {
  input: set val(pair), file(reads) from ...
  output: set val(pair), file('*.bam') into bam_ch
  &quot;&quot;&quot;
  your_command --here
  &quot;&quot;&quot;
}

process bar {
  input: set val(pair), file(reads) from ...
  output: set val(pair), file('*.bai') into bai_ch
  &quot;&quot;&quot;
  other_command --here
  &quot;&quot;&quot;
}

process gather {
  input:
  set val(pair), file(bam) from bam_ch
  set val(pair), file(bai) from bai_ch
  &quot;&quot;&quot;
  merge_command $bam $bai
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The inputs declared at line 19,20 can be delivered in any
order because the execution order of the process <code>foo</code> and
<code>bar</code> is not deterministic due to the parallel executions of them.</p>
</div>
<div class="paragraph">
<p>Therefore the input of the third process needs to be synchronized
using the <a href="https://www.nextflow.io/docs/latest/operator.html#join">join</a>
operator or a similar approach. The third process should be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>...

process gather {
  input:
  set val(pair), file(bam), file(bai) from bam_ch.join(bai_ch)
  &quot;&quot;&quot;
  merge_command $bam $bai
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_errors_handling_troubleshooting">12. Errors handling &amp; troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_execution_errors_debugging">12.1. Execution errors debugging</h3>
<div class="paragraph">
<p>When a process execution exit with a non-zero exit status, Nextflow stops the workflow execution and report the failing task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="cmd">ERROR ~ Error executing process &gt; 'index'

Caused by:           <i class="conum" data-value="1"></i><b>(1)</b>
  Process `index` terminated with an error exit status (127)

Command executed:    <i class="conum" data-value="2"></i><b>(2)</b>

  salmon index --threads 1 -t transcriptome.fa -i index

Command exit status: <i class="conum" data-value="3"></i><b>(3)</b>
  127

Command output:      <i class="conum" data-value="4"></i><b>(4)</b>
  (empty)

Command error:       <i class="conum" data-value="5"></i><b>(5)</b>
  .command.sh: line 2: salmon: command not found

Work dir:            <i class="conum" data-value="6"></i><b>(6)</b>
  /Users/pditommaso/work/0b/b59f362980defd7376ee0a75b41f62</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A description of the error cause</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The command executed</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The command exit status</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The command standard output, when available</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command standard error</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The command work directory</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Review carefully all these data, they can provide valuable information on the cause of the error.</p>
</div>
<div class="paragraph">
<p>If this is not enough, change in the task work directory. It contains all the files to replicate the issue in a isolated manner.</p>
</div>
<div class="paragraph">
<p>The task execution directory contains these files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.command.sh</code>: The command script.</p>
</li>
<li>
<p><code>.command.run</code>: The command wrapped used to run the job.</p>
</li>
<li>
<p><code>.command.out</code>: The complete job standard output.</p>
</li>
<li>
<p><code>.command.err</code>: The complete job standard error.</p>
</li>
<li>
<p><code>.command.log</code>: The wrapper execution output.</p>
</li>
<li>
<p><code>.command.begin</code>: Sentinel file created as soon as the job is launched.</p>
</li>
<li>
<p><code>.exitcode</code>: A file containing the task exit code.</p>
</li>
<li>
<p>Task input files (symlinks)</p>
</li>
<li>
<p>Task output files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Verify that the <code>.command.sh</code> file contains the expected command to be executed and all variables are correctly resolved.</p>
</div>
<div class="paragraph">
<p>Also verify the existence of the file <code>.exitcode</code> file. If missing and also the file <code>.command.begin</code> does not exist, the task was never executed by the subsystem (eg. the batch scheduler). If the <code>.command.begin</code> file exist, the job was launched but the it likely was abruptly killed.</p>
</div>
<div class="paragraph">
<p>You can replicate the failing execution using the command <code>bash .command.run</code> and verify the cause of the error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ignore_errors">12.2. Ignore errors</h3>
<div class="paragraph">
<p>There are cases in which a process error may be expected and it should not stop the overall workflow execution.</p>
</div>
<div class="paragraph">
<p>To handle this use case set the process <code>errorStrategy</code> to <code>ignore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>process foo {
  errorStrategy 'ignore'
  script:
  &quot;&quot;&quot;
    your_command --this --that
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to ignore any error set the same directive in the config file as default setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="config"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>process.errorStrategy = 'ignore'</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_error_fail_over">12.3. Automatic error fail-over</h3>
<div class="paragraph">
<p>In (rare) cases errors may be caused by transient conditions. In this situation an effective strategy
consistent in trying to re-execute the failing task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>process foo {
  errorStrategy 'retry'
  script:
  &quot;&quot;&quot;
    your_command --this --that
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>retry</code> error strategy the task is re-executed a second time if it returns a non-zero exit status
before stopping the complete workflow execution.</p>
</div>
<div class="paragraph">
<p>The directive <a href="https://www.nextflow.io/docs/latest/process.html#maxretries">maxRetries</a> can be used to
set number of attempts the task can be re-execute before declaring it failed with an error condition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retry_with_backoff">12.4. Retry with backoff</h3>
<div class="paragraph">
<p>There are cases in which the required execution resources may be
temporary unavailable e.g. network congestion. In these cases simply
re-executing the same task will likely result in the identical error.
A retry with an exponential backoff delay can better recover
these error conditions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>process foo {
  errorStrategy { sleep(Math.pow(2, task.attempt) * 200 as long); return 'retry' }
  maxRetries 5
  script:
  '''
  your_command --here
  '''
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_resources_allocation">12.5. Dynamic resources allocation</h3>
<div class="paragraph">
<p>It&#8217;s a very common scenario that different instances of the same process may have very different needs in terms of computing resources. In such situations requesting, for example, an amount of memory too low will cause some tasks to fail. Instead, using a higher limit that fits all the tasks in your execution could significantly decrease the execution priority of your jobs.</p>
</div>
<div class="paragraph">
<p>To handle this use case you can use a <code>retry</code> error strategy and increasing the computing resources allocated by the job at each successive <em>attempt</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nextflow"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>process foo {
  cpus 4
  memory { 2.GB * task.attempt }   <i class="conum" data-value="1"></i><b>(1)</b>
  time { 1.hour * task.attempt }   <i class="conum" data-value="2"></i><b>(2)</b>
  errorStrategy { task.exitStatus == 140 ? 'retry' : 'terminate' }   <i class="conum" data-value="3"></i><b>(3)</b>
  maxRetries 3   <i class="conum" data-value="4"></i><b>(4)</b>

  script:
  &quot;&quot;&quot;
    your_command --cpus $task.cpus --mem $task.memory
  &quot;&quot;&quot;
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The memory is defined in a dynamic manner, the first attempt is 2 GB, the second 4 GB, and so on.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The wall execution time is set dynamically as well, the first execution attempt is set to 1 hour, the second 2 hours, and so on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the task return an exit status equals to <code>140</code> sets the error strategy to <code>retry</code> otherwise terminates the execution.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>It can retry the process execution up to three times.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<div id="footer">
    <div id="footer-text">
        Creative Commons CC BY-NC-ND (Attribution-NonCommercial-ShareAlike-NoDerivatives) <span class="image right CC BY-NC-ND"><img src="img/by-nc-nd.png" alt="CC BY-NC-ND" height="30" width="120"></span>
    </div>
    <div id="footer-text">
        Copyright 2020, <a href="https://www.seqera.io">Seqera Labs</a>. All rights reserved. Not for redistribution.
    </div>
</div>
</body>
</html>