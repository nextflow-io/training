name: Nextflow Lint

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v2

      - name: Run Nextflow lint
        run: |
          mkdir -p lint-results
          nextflow lint . -o json > lint-results/lint-output.json 2>&1 || true

      - name: Generate markdown report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lintOutput = JSON.parse(fs.readFileSync('lint-results/lint-output.json', 'utf8'));
            const { summary, errors } = lintOutput;
            const sha = context.sha;
            const repo = `${context.repo.owner}/${context.repo.repo}`;

            let markdown = '**Nextflow linting complete!**\n\n';

            if (summary.errors === 0) {
              markdown += `✅ ${summary.filesWithoutErrors} files had no errors\n`;
            } else {
              markdown += `❌ ${summary.filesWithErrors} files had ${summary.errors} errors\n`;
              markdown += `✅ ${summary.filesWithoutErrors} files had no errors\n\n`;

              // Group errors by file
              const grouped = {};
              for (const err of errors) {
                if (!grouped[err.filename]) {
                  grouped[err.filename] = [];
                }
                grouped[err.filename].push(err);
              }

              // Build table rows
              const rows = [];
              for (const [filename, fileErrors] of Object.entries(grouped).sort()) {
                for (const err of fileErrors) {
                  const location = `${err.startLine}:${err.startColumn}`;
                  const link = `[${filename}:${location}](https://github.com/${repo}/blob/${sha}/${filename}#L${err.startLine})`;
                  rows.push(`| ${link} | ${err.message} |`);
                }
              }

              markdown += `<details>\n<summary>View all ${summary.errors} issues</summary>\n\n`;
              markdown += `| Location | Message |\n|----------|---------|\n`;
              markdown += rows.join('\n');
              markdown += `\n\n</details>\n`;
            }

            // Write to file
            fs.writeFileSync('lint-results/report.md', markdown);

            // Add to job summary
            await core.summary
              .addRaw(markdown)
              .write();

      - name: Save PR info
        if: github.event_name == 'pull_request'
        run: |
          echo "${{ github.event.pull_request.number }}" > lint-results/pr-number.txt
          echo "${{ github.sha }}" > lint-results/head-sha.txt

      - name: Upload lint results
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results/
          retention-days: 1
